# é™æ€é“¾æ¥

## 1.ç©ºé—´å’Œåœ°å€åˆ†é…

### 1.1 ç›¸ä¼¼æ®µåˆå¹¶

å¯¹äºé“¾æ¥å™¨æ¥è¯´ï¼Œæ•´ä¸ªé“¾æ¥è¿‡ç¨‹ä¸­ï¼Œå®ƒå°±æ˜¯å°†å‡ ä¸ªè¾“å…¥ç›®æ ‡æ–‡ä»¶åŠ å·¥ååˆå¹¶æˆä¸€ä¸ªè¾“å‡ºæ–‡ä»¶ã€‚å¯¹äºå¤šä¸ªè¾“å…¥ç›®æ ‡æ–‡ä»¶ï¼Œé“¾æ¥å™¨å°†ç›¸åŒæ€§è´¨çš„æ®µåˆå¹¶åˆ°ä¸€èµ·ï¼Œæ¯”å¦‚å°†æ‰€æœ‰è¾“å…¥æ–‡ä»¶çš„ **`.text`** åˆå¹¶åˆ°è¾“å‡ºæ–‡ä»¶çš„ **`.text`** æ®µï¼Œæ¥ç€æ˜¯ **`.data`** æ®µã€**`.bss`** æ®µç­‰ã€‚**`.bss`** **<font color="red">æ®µåœ¨ç›®æ ‡æ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶ä¸­å¹¶ä¸å ç”¨æ–‡ä»¶çš„ç©ºé—´ï¼Œä½†æ˜¯å®ƒåœ¨è£…è½½æ—¶å ç”¨åœ°å€ç©ºé—´</font>**ã€‚æ‰€ä»¥é“¾æ¥å™¨åœ¨åˆå¹¶å„ä¸ªæ®µçš„åŒæ—¶ï¼Œä¹Ÿå°† **`.bss`** åˆå¹¶ï¼Œå¹¶ä¸”åˆ†é…è™šæ‹Ÿç©ºé—´ã€‚

ç°åœ¨é“¾æ¥å™¨ä¸€èˆ¬éƒ½é‡‡ç”¨ä¸€ç§å« **ä¸¤æ­¥é“¾æ¥ï¼ˆTwo-pass Linkingï¼‰** çš„æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´æ•´ä¸ªé“¾æ¥è¿‡ç¨‹åˆ†ä¸¤æ­¥ã€‚

- **ç©ºé—´ä¸åœ°å€åˆ†é…**ï¼šæ‰«ææ‰€æœ‰çš„è¾“å…¥ç›®æ ‡æ–‡ä»¶ï¼Œå¹¶ä¸”è·å¾—å®ƒä»¬çš„å„ä¸ªæ®µçš„é•¿åº¦ã€å±æ€§å’Œä½ç½®ï¼Œå¹¶ä¸”å°†è¾“å…¥ç›®æ ‡æ–‡ä»¶ä¸­çš„ç¬¦å·è¡¨ä¸­æ‰€æœ‰çš„ç¬¦å·å®šä¹‰å’Œç¬¦å·å¼•ç”¨æ”¶é›†èµ·æ¥ï¼Œç»Ÿä¸€æ”¾åˆ°ä¸€ä¸ªå…¨å±€ç¬¦å·è¡¨ã€‚è¿™ä¸€æ­¥ä¸­ï¼Œé“¾æ¥å™¨å°†èƒ½å¤Ÿè·å¾—æ‰€æœ‰è¾“å…¥ç›®æ ‡æ–‡ä»¶çš„æ®µé•¿åº¦ï¼Œå¹¶ä¸”å°†å®ƒä»¬åˆå¹¶ï¼Œè®¡ç®—å‡ºè¾“å‡ºæ–‡ä»¶ä¸­å„ä¸ªæ®µåˆå¹¶åçš„é•¿åº¦ä¸ä½ç½®ï¼Œå¹¶å»ºç«‹æ˜ å°„å…³ç³»ã€‚
- **ç¬¦å·è§£æä¸é‡å®šä½**ï¼šä½¿ç”¨ä¸Šé¢ç¬¬ä¸€æ­¥ä¸­æ”¶é›†åˆ°çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè¯»å–è¾“å…¥æ–‡ä»¶ä¸­æ®µçš„æ•°æ®ã€é‡å®šä½ä¿¡æ¯ï¼Œå¹¶ä¸”è¿›è¡Œç¬¦å·è§£æä¸é‡å®šä½ï¼Œè°ƒæ•´ä»£ç ä¸­çš„åœ°å€ç­‰ã€‚äº‹å®ä¸Šç¬¬äºŒæ­¥æ˜¯é“¾æ¥è¿‡ç¨‹çš„æ ¸å¿ƒï¼Œç‰¹åˆ«æ˜¯é‡å®šä½è¿‡ç¨‹ã€‚

æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢ a.c å’Œ b.c æ–‡ä»¶æ¥åˆ†æé™æ€é“¾æ¥è¿‡ç¨‹ï¼š

```c{.line-numbers}
// a.c
extern int shared;
int main() {
    int a = 100;
    swap(&a, &shared);
}

// b.c
int shared = 1;
void swap(int* a, int* b) {
    *a ^= *b ^= *a ^= *b;
}
```

æˆ‘ä»¬ä½¿ç”¨ ld é“¾æ¥å™¨å°† a.o å’Œ b.o é“¾æ¥èµ·æ¥ï¼Œ**`ld a.o b.o -e main -o ab`**ï¼Œå…¶ä¸­ **`-e main`** è¡¨ç¤ºå°† main å‡½æ•°ä½œä¸ºç¨‹åºå…¥å£ï¼Œld é“¾æ¥å™¨å°†é»˜è®¤ç¨‹åºçš„å…¥å£è®¾ç½®ä¸º **`_start`**ã€‚

```c{.line-numbers}
monica@monica-virtual-machine:~/linkers_loaders$ readelf -S a.o
There are 14 section headers, starting at offset 0x298:

èŠ‚å¤´ï¼š
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .group            GROUP           00000000 000034 000008 04     11   5  4
  [ 2] .text             PROGBITS        00000000 00003c 00004a 00  AX  0   0  1
  [ 3] .rel.text         REL             00000000 0001ec 000020 08   I 11   2  4
  [ 4] .data             PROGBITS        00000000 000086 000000 00  WA  0   0  1
  [ 5] .bss              NOBITS          00000000 000086 000000 00  WA  0   0  1
  [ 6] .text.__x86.[...] PROGBITS        00000000 000086 000004 00 AXG  0   0  1
  [ 7] .comment          PROGBITS        00000000 00008a 00002c 01  MS  0   0  1
  [ 8] .note.GNU-stack   PROGBITS        00000000 0000b6 000000 00      0   0  1
  [ 9] .eh_frame         PROGBITS        00000000 0000b8 000060 00   A  0   0  4
  [10] .rel.eh_frame     REL             00000000 00020c 000010 08   I 11   9  4
  [11] .symtab           SYMTAB          00000000 000118 000090 10     12   4  4
  [12] .strtab           STRTAB          00000000 0001a8 000042 00      0   0  1
  [13] .shstrtab         STRTAB          00000000 00021c 00007a 00      0   0  1

monica@monica-virtual-machine:~/linkers_loaders$ readelf -S b.o
There are 14 section headers, starting at offset 0x25c:

èŠ‚å¤´ï¼š
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .group            GROUP           00000000 000034 000008 04     11   6  4
  [ 2] .text             PROGBITS        00000000 00003c 000043 00  AX  0   0  1
  [ 3] .rel.text         REL             00000000 0001c0 000010 08   I 11   2  4
  [ 4] .data             PROGBITS        00000000 000080 000004 00  WA  0   0  4
  [ 5] .bss              NOBITS          00000000 000084 000000 00  WA  0   0  1
  [ 6] .text.__x86.[...] PROGBITS        00000000 000084 000004 00 AXG  0   0  1
  [ 7] .comment          PROGBITS        00000000 000088 00002c 01  MS  0   0  1
  [ 8] .note.GNU-stack   PROGBITS        00000000 0000b4 000000 00      0   0  1
  [ 9] .eh_frame         PROGBITS        00000000 0000b4 00004c 00   A  0   0  4
  [10] .rel.eh_frame     REL             00000000 0001d0 000010 08   I 11   9  4
  [11] .symtab           SYMTAB          00000000 000100 000080 10     12   4  4
  [12] .strtab           STRTAB          00000000 000180 00003d 00      0   0  1
  [13] .shstrtab         STRTAB          00000000 0001e0 00007a 00      0   0  1

monica@monica-virtual-machine:~/linkers_loaders$ readelf -S ab
There are 9 section headers, starting at offset 0x31a0:

èŠ‚å¤´ï¼š
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .text             PROGBITS        08049000 001000 000091 00  AX  0   0  1
  [ 2] .eh_frame         PROGBITS        0804a000 002000 000080 00   A  0   0  4
  [ 3] .got.plt          PROGBITS        0804c000 003000 00000c 04  WA  0   0  4
  [ 4] .data             PROGBITS        0804c00c 00300c 000004 00  WA  0   0  4
  [ 5] .comment          PROGBITS        00000000 003010 00002b 01  MS  0   0  1
  [ 6] .symtab           SYMTAB          00000000 00303c 0000c0 10      7   5  4
  [ 7] .strtab           STRTAB          00000000 0030fc 00005e 00      0   0  1
  [ 8] .shstrtab         STRTAB          00000000 00315a 000043 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  D (mbind), p (processor specific)
```

#### 1.1.1 èŠ‚ç»„

ä»ä¸Šé¢ **`a.o`**ã€**`b.o`** å’Œ ab ä¸‰ä¸ªæ–‡ä»¶çš„æ®µè¡¨å¯ä»¥çœ‹å‡ºï¼Œa.o æ–‡ä»¶çš„ **`.text`** æ®µå¤§å°ä¸º 0x4aï¼Œb.o æ–‡ä»¶çš„ **`.text`** æ®µå¤§å°ä¸º 0x43ï¼ŒåŠ èµ·æ¥å¹¶ä¸ç­‰äº ab ä¸­çš„ **`.text`** æ®µçš„å¤§å° 0x91ã€‚è¿™æ˜¯å› ä¸ºåœ¨ a.o å’Œ b.o ä¸­éƒ½æœ‰ 4 å­—èŠ‚çš„ **`.text.__x86.get_pc_thunk.ax`** æ¡©ä»£ç ï¼Œé“¾æ¥å™¨åœ¨é“¾æ¥æ—¶ä» **`a.o`** å’Œ **`b.o`** ä¸­æŒ‘ 1 ä»½ï¼ˆåªæœ‰ 1 ä»½ï¼‰å¹¶å…¥åˆ° ab ç¨‹åºçš„ .text ä¸­ã€‚åœ¨ a.o å’Œ b.o ä¸­ï¼Œ**`__x86.get_pc_thunk.ax`** æ¡©ä»£ç éƒ½å±äºä¸€ç§ç‰¹æ®Šçš„èŠ‚ç»„ **`GRP_COMDAT`**ã€‚

æ ¹æ®æ–‡æ¡£ï¼ŒSome sections occur in interrelated groups. For example, an out-of-line definition of an inline function might require, in addition to the section containing its executable instructions, a read-only data section containing literals referenced, one or more debugging information sections and other informational sections. Furthermore, there may be internal references among these sections that would not make sense if one of the sections were removed or replaced by a duplicate from another object. Therefore, such groups must be included or omitted from the linked object as a unit. A section cannot be a member of more than one group. 

è¿™æ®µè¯æè¿°äº†è¿™ä¹ˆä¸€ä¸ªåœºæ™¯ï¼Œå‡è®¾ä¸€ä¸ªå‡½æ•° **`foo()`**ã€‚å®ƒçš„æœºå™¨ç åœ¨ **`.text`** èŠ‚ï¼Œå®ƒç”¨åˆ°çš„ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡åœ¨ **`.rodata`** èŠ‚ï¼Œå®ƒçš„è°ƒè¯•ä¿¡æ¯åœ¨ **`.debug_info`** èŠ‚ï¼Œè¿™ä¸‰ä¸ªèŠ‚æ˜¯ç´§å¯†å…³è”çš„ï¼Œä½œä¸ºä¸€ä¸ªåŸå­å•å…ƒæ¥å¤„ç†ã€‚å› æ­¤ï¼Œå½“é“¾æ¥å™¨å†³å®šä¸¢å¼ƒæˆ–æ›¿æ¢æ—¶ï¼Œå¿…é¡»æŠŠå®ƒä»¬ä½œä¸ºä¸€ä¸ªæ•´ä½“å¤„ç†ã€‚è¿™æ­£æ˜¯ **`SHT_GROUP`** çš„ç›®çš„ï¼ŒæŠŠç›¸å…³èŠ‚åˆ—åœ¨ä¸€ä¸ªç»„èŠ‚é‡Œï¼Œå¿…è¦æ—¶æ•´ä½“ä¿ç•™æˆ–æ•´ä½“ä¸¢å¼ƒã€‚

A section which is part of a group, and is to be retained or discarded with the group as a whole, is identified by a new section header attribute **`SHF_GROUP`**. **<font color="red">This section is a member (perhaps the only one) of a group of sections, and the linker should retain or discard all or none of the members</font>**.

A section cannot be a member of more than one group. èŠ‚ä¸èƒ½åŒæ—¶å±äºå¤šä¸ªç»„ï¼Œå¦‚æœæŸä¸ªå­—ç¬¦ä¸²å¸¸é‡è¢«å¤šå¤„å…±äº«ï¼Œå®ƒé€šå¸¸ä¸ä¼šè¢«æ”¾è¿›"æ¯ä¸ªå‡½æ•°çš„ç§æœ‰ç»„"ï¼›æƒ³è¦æŠŠæŸå‡½æ•°æ‰€éœ€å¸¸é‡è·Ÿå®ƒç»‘å®šï¼Œç¼–è¯‘å™¨ä¼šæŠŠè¯¥å¸¸é‡æ”¾è¿›è¯¥å‡½æ•°ä¸“ç”¨çš„å°èŠ‚å¹¶æŠŠè¿™ä¸ªå°èŠ‚åŠ ä¸Š **`SHF_GROUP`**ï¼Œå†ç”± **`SHT_GROUP`** æŠŠè¿™äº›æˆå‘˜èŠ‚ä¸²èµ·æ¥ã€‚

>**`SHF_GROUP`** æ˜¯èŠ‚æ ‡å¿—ï¼Œæ˜¯ **`sh_flags`** æ ‡å¿—ä½ä¸­çš„ä¸€ä½ï¼Œå¸¸åœ¨ **`readelf -S`** çš„ **`Flg`** åˆ—æ˜¾ç¤ºä¸º Gã€‚**`SHT_GROUP`** æ˜¯ä¸€ç§ä¸“é—¨çš„èŠ‚ç±»å‹ï¼Œç±»ä¼¼äº **`SHT_SYMTAB`** è¡¨ç¤ºè¯¥æ®µçš„å†…å®¹ä¸ºç¬¦å·è¡¨ï¼Œ**`SHT_GROUP`** èŠ‚çš„èŠ‚æ•°æ®æ˜¯ **`Elf32_Word`** é¡¹çš„æ•°ç»„ã€‚ç¬¬ä¸€é¡¹æ˜¯ä¸€ä¸ªæ ‡å¿—å­—ã€‚å…¶ä½™é¡¹æ˜¯ä¸€ç³»åˆ—èŠ‚å¤´ç´¢å¼•ã€‚

This is a COMDAT group. It may duplicate another COMDAT group in another object file, where duplication is defined as having the same group signature. In such cases, only one of the duplicate groups may be retained by the linker, and the members of the remaining groups must be discarded. ä¹Ÿå°±æ˜¯è¯´ COMDAT æ˜¯ä¸€ç§ç‰¹æ®Šçš„èŠ‚ç»„ï¼Œç”¨äºæ”¯æŒå¤šä¸ªç›®æ ‡æ–‡ä»¶ä¸­çš„ç›¸åŒç¬¦å·ï¼ˆä¾‹å¦‚å†…è”å‡½æ•°ï¼‰ã€‚COMDAT ç»„å…è®¸åŒä¸€ç¬¦å·çš„å¤šä¸ªå®šä¹‰ï¼Œé“¾æ¥å™¨ä¼šæ ¹æ®å…¶ç¬¦å·ç­¾åæ¥è¯†åˆ«å¹¶ä¿ç•™å”¯ä¸€çš„å‰¯æœ¬ã€‚åœ¨é“¾æ¥æ—¶ï¼Œå¦‚æœé“¾æ¥å™¨å‘ç°ç›¸åŒçš„ç¬¦å·ç­¾åï¼Œå®ƒä¼šä¿ç•™å…¶ä¸­ä¸€ä¸ªèŠ‚ç»„ï¼Œå…¶ä½™çš„ä¼šè¢«ä¸¢å¼ƒã€‚è¿™ç§æœºåˆ¶ä¿è¯äº†åœ¨é“¾æ¥æ—¶ï¼Œå¦‚æœå¤šä¸ªæºæ–‡ä»¶ä¸­éƒ½æœ‰å¯¹åŒä¸€ä¸ªå†…è”å‡½æ•°æˆ–æ¨¡æ¿çš„å®šä¹‰ï¼Œæœ€ç»ˆé“¾æ¥å‡ºæ¥çš„ç¨‹åºåªåŒ…å«ä¸€ä¸ªå®šä¹‰ã€‚

```c{.line-numbers}
monica@monica-virtual-machine:~/linkers_loaders$ readelf -g a.o
COMDAT group section [    1] `.group' [__x86.get_pc_thunk.ax] contains 1 sections:
   [Index]    Name
   [    6]   .text.__x86.get_pc_thunk.ax

monica@monica-virtual-machine:~/linkers_loaders$ readelf -g b.o
COMDAT group section [    1] `.group' [__x86.get_pc_thunk.ax] contains 1 sections:
   [Index]    Name
   [    6]   .text.__x86.get_pc_thunk.ax
```

ä¸ºäº†ä¾¿äºç†è§£ **`GRP_COMDAT`**ï¼Œæˆ‘ä»¬ä½¿ç”¨ C++ æ¨¡æ¿å‡½æ•°ä½œä¸ºä¾‹å­ï¼Œåˆ›å»ºå¦‚ä¸‹ 3 ä¸ªæ–‡ä»¶ï¼š

```c{.line-numbers}
// template.h
#pragma once
#include <iostream>
template<typename T>
void print_value(T value) {
    const char* message = "The value is: "; // ä¸€ä¸ªç›¸å…³çš„åªè¯»æ•°æ®
    std::cout << message << value << std::endl;
}

// a.cpp
#include "template.h"
void func_a() {
    print_value(100); // å®ä¾‹åŒ– print_value<int>
}

// b.cpp
#include "template.h"
void func_b() {
    print_value(200); // å†æ¬¡å®ä¾‹åŒ– print_value<int>
}

// main.cpp
void func_a();
void func_b();

int main() {
    func_a();
    func_b();
    return 0;
}
```

ç¼–è¯‘ä¸ºç›®æ ‡æ–‡ä»¶ã€‚

```c{.line-numbers}
g++ -c a.cpp -o a.o -m32
g++ -c b.cpp -o b.o -m32
g++ -c main.cpp -o main.o -m32
```

å¦‚ä¸‹æ˜¯ **`a.o`** å’Œ **`main.o`** ä¸­çš„èŠ‚ç»„ä¿¡æ¯ï¼Œåœ¨ **`a.o`** ä¸­ï¼Œ**<font color="red">ç¼–è¯‘å™¨å°†å®ä¾‹åŒ–åçš„æ¨¡ç‰ˆå‡½æ•° **`print_value(int)`** æ”¾å…¥åˆ° COMDAT ç»„</font>**ã€‚å› ä¸ºå¦‚æœ **`print_value`** å®šä¹‰åœ¨å¤´æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆå…¶ä»–ç¼–è¯‘å•å…ƒï¼ˆå¦‚ **`b.cpp`**ï¼‰ä¹Ÿå¯èƒ½ä¼šå®ä¾‹åŒ–å®ƒï¼Œä»è€Œå¯¼è‡´é“¾æ¥æ—¶å‡ºç°"å¤šé‡å®šä¹‰"é”™è¯¯ã€‚COMDAT æœºåˆ¶ä½¿å¾—é“¾æ¥å™¨åœ¨é‡åˆ°å¤šä¸ªåŒç­¾åçš„ COMDAT ç»„æ—¶ï¼Œåªä¼šä¿ç•™ä¸€ä¸ªï¼Œå…¶ä»–çš„å…¨éƒ¨ä¸¢å¼ƒã€‚

å¦å¤–åœ¨ **`print_value(int)`** çš„ COMDAT ç»„ä¸­ï¼Œä¸ä»…åŒ…å«äº†æ­¤æ¨¡æ¿å‡½æ•°çš„ä»£ç ï¼Œè¿˜åŒ…å«äº†å…¶é‡å®šä½ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œ**`print_value`** å†…éƒ¨è°ƒç”¨äº† **`std::cout`**ï¼Œè¿™ä¸ªè°ƒç”¨åœ°å€åœ¨ç¼–è¯‘æ—¶æ˜¯ä¸ç¡®å®šçš„ï¼Œéœ€è¦é“¾æ¥å™¨æ¥å¡«å……ã€‚å°†é‡å®šä½èŠ‚ä¹Ÿæ”¾å…¥ç»„å†…ï¼Œä¿è¯äº†å¤„ç†çš„åŸå­æ€§ã€‚å¦‚æœé“¾æ¥å™¨å†³å®šä¸¢å¼ƒ a.o ä¸­çš„è¿™ä¸ª **`print_value`** å®ç°ï¼ˆå› ä¸ºå®ƒå¯èƒ½é€‰æ‹©äº† b.o ä¸­çš„ç‰ˆæœ¬ï¼‰ï¼Œå®ƒä¼šæŠŠå¯¹åº”çš„ä»£ç èŠ‚å’Œé‡å®šä½èŠ‚ä¸€èµ·ä¸¢å¼ƒã€‚

åŒæ—¶ï¼Œåœ¨ a.o ä¸­ç¼–è¯‘å™¨ç”Ÿæˆäº† **`__x86.get_pc_thunk.ax`** å’Œ **`__x86.get_pc_thunk.bx`** ä¸¤ä¸ªè¾…åŠ©å‡½æ•°ï¼Œè¿™ä¸¤ä¸ªè¾…åŠ©å‡½æ•°åœ¨å…¶ä»–çš„åœ°å€æ— å…³æ–‡ä»¶ä¸­ä¹Ÿå¯èƒ½ç”¨åˆ°ï¼Œæ‰€ä»¥è¿™é‡Œç¼–è¯‘å™¨ä¹Ÿå°†å…¶æ”¾åˆ° COMDAT ç»„ä¸­è¿›è¡Œå»é‡ã€‚

```c{.line-numbers}
monica@monica-virtual-machine:~/linkers_loaders$ readelf -g a.o
COMDAT group section [    1] `.group' [_Z11print_valueIiEvT_] contains 2 sections:
   [Index]    Name
   [    9]   .text._Z11print_valueIiEvT_
   [   10]   .rel.text._Z11print_valueIiEvT_

COMDAT group section [    2] `.group' [__x86.get_pc_thunk.ax] contains 1 sections:
   [Index]    Name
   [   13]   .text.__x86.get_pc_thunk.ax

COMDAT group section [    3] `.group' [__x86.get_pc_thunk.bx] contains 1 sections:
   [Index]    Name
   [   14]   .text.__x86.get_pc_thunk.bx

monica@monica-virtual-machine:~/linkers_loaders$ readelf -g main.o
COMDAT group section [    1] `.group' [__x86.get_pc_thunk.bx] contains 1 sections:
   [Index]    Name
   [    6]   .text.__x86.get_pc_thunk.bx
```

#### 1.1.2 æ®µåˆå¹¶

ä»ä¸‹é¢çš„æ®µè¡¨å¯ä»¥çœ‹å‡ºï¼Œ**`.comment`**ã€**`.symtab`**ã€**`.strtab`**ã€**`.shstrtab`** è¿™ 4 ä¸ªæ®µçš„ Addr å€¼ä¸º 0ï¼Œè¿™æ˜¯å› ä¸ºè¿™äº›èŠ‚åªåœ¨é“¾æ¥å’Œè°ƒè¯•æ—¶æœ‰ç”¨ï¼Œå½“æ“ä½œç³»ç»ŸåŠ è½½å™¨å°†ç¨‹åºä»ç£ç›˜æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­å‡†å¤‡è¿è¡Œæ—¶ï¼Œå®ƒä¼šå®Œå…¨å¿½ç•¥è¿™äº›èŠ‚ï¼Œä¸ä¸ºå®ƒä»¬åˆ†é…ä»»ä½•å†…å­˜ç©ºé—´ã€‚å› æ­¤æ—¢ç„¶è¿™äº›èŠ‚ä¸è¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå®ƒä»¬è‡ªç„¶ä¹Ÿå°±æ²¡æœ‰å†…å­˜åœ°å€ï¼Œæ‰€ä»¥ Addr å­—æ®µè¢«è®¾ç½®ä¸º 0ã€‚

å¹¶ä¸”ç”±äº **`.text`** æ®µçš„å†…å­˜æƒé™æ˜¯å¯è¯»å¯æ‰§è¡Œï¼Œ**`.eh_frame`** æ®µçš„å†…å­˜æƒé™æ˜¯åªè¯»ï¼Œ**`.got.plt`** å’Œ **`.data`** çš„æƒé™æ˜¯å¯è¯»å¯å†™ï¼Œå› æ­¤é“¾æ¥å™¨æŒ‰ç…§æƒé™åˆ†ç»„ï¼Œå°†æ‰€æœ‰å…·æœ‰ç›¸åŒå†…å­˜æƒé™éœ€æ±‚çš„èŠ‚èšåˆåœ¨ä¸€èµ·ã€‚

```c{.line-numbers}
monica@monica-virtual-machine:~/linkers_loaders$ readelf -S ab
There are 9 section headers, starting at offset 0x31a0:

èŠ‚å¤´ï¼š
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .text             PROGBITS        08049000 001000 000091 00  AX  0   0  1
  [ 2] .eh_frame         PROGBITS        0804a000 002000 000080 00   A  0   0  4
  [ 3] .got.plt          PROGBITS        0804c000 003000 00000c 04  WA  0   0  4
  [ 4] .data             PROGBITS        0804c00c 00300c 000004 00  WA  0   0  4
  [ 5] .comment          PROGBITS        00000000 003010 00002b 01  MS  0   0  1
  [ 6] .symtab           SYMTAB          00000000 00303c 0000c0 10      7   5  4
  [ 7] .strtab           STRTAB          00000000 0030fc 00005e 00      0   0  1
  [ 8] .shstrtab         STRTAB          00000000 00315a 000043 00      0   0  1

monica@monica-virtual-machine:~/linkers_loaders$ readelf -l ab

Elf æ–‡ä»¶ç±»å‹ä¸º EXEC (å¯æ‰§è¡Œæ–‡ä»¶)
Entry point 0x8049000
There are 5 program headers, starting at offset 52

ç¨‹åºå¤´ï¼š
  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
  LOAD           0x000000 0x08048000 0x08048000 0x000d4 0x000d4 R   0x1000
  LOAD           0x001000 0x08049000 0x08049000 0x00091 0x00091 R E 0x1000
  LOAD           0x002000 0x0804a000 0x0804a000 0x00080 0x00080 R   0x1000
  LOAD           0x003000 0x0804c000 0x0804c000 0x00010 0x00010 RW  0x1000
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x10

 Section to Segment mapping:
  æ®µèŠ‚...
   00     
   01     .text 
   02     .eh_frame 
   03     .got.plt .data 

monica@monica-virtual-machine:~/linkers_loaders$ readelf -h ab
ELF å¤´ï¼š
  Magicï¼š   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00 
  ç±»åˆ«:                              ELF32
  æ•°æ®:                              2 è¡¥ç ï¼Œå°ç«¯åº (little endian)
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI ç‰ˆæœ¬:                          0
  ç±»å‹:                              EXEC (å¯æ‰§è¡Œæ–‡ä»¶)
  ç³»ç»Ÿæ¶æ„:                          Intel 80386
  ç‰ˆæœ¬:                              0x1
  å…¥å£ç‚¹åœ°å€ï¼š                        0x8049000
  ç¨‹åºå¤´èµ·ç‚¹ï¼š                        52 (bytes into file)
  Start of section headers:          12704 (bytes into file)
  æ ‡å¿—ï¼š                              0x0
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         5
  Size of section headers:           40 (bytes)
  Number of section headers:         9
  Section header string table index: 8
```

å¦å¤–ï¼Œ**`.text`** æ®µæ²¡æœ‰ä» **`0x08048000`** å¼€å§‹ï¼Œæ˜¯å› ä¸ºä» **`0x08048000`** å¼€å§‹çš„ç¬¬ä¸€ä¸ªå†…å­˜é¡µï¼ˆç¬¬ 1 ä¸ª **`PT_LOAD`** æ®µï¼‰ï¼Œè¢«ç”¨æ¥å­˜æ”¾ ELF å¤´å’Œç¨‹åºå¤´è¡¨ã€‚ELF å¤´å¤§å°ä¸º 52 å­—èŠ‚ï¼Œè€Œç¨‹åºå¤´è¡¨çš„æ€»å¤§å°ä¸º 160 å­—èŠ‚ï¼Œæ€»å¤§å°ä¸º 212 å­—èŠ‚ï¼Œåˆšå¥½ç­‰äºç¬¬ä¸€ä¸ª **`PT_LOAD`** æ®µçš„å¤§å° 0x000d4ï¼ˆ212 å­—èŠ‚ï¼‰ã€‚

#### 1.1.3 ç¬¦å·åœ°å€ç¡®å®š

æˆ‘ä»¬è¿˜æ˜¯ä»¥ **`a.o`** å’Œ **`b.o`** ä½œä¸ºä¾‹å­ï¼Œæ¥åˆ†æè¿™ä¸¤ä¸ªæ­¥éª¤ä¸­é“¾æ¥å™¨çš„å·¥ä½œè¿‡ç¨‹ã€‚åœ¨ç¬¬ä¸€æ­¥çš„æ‰«æå’Œç©ºé—´åˆ†é…é˜¶æ®µï¼Œé“¾æ¥å™¨æŒ‰ç…§å‰é¢ä»‹ç»çš„ç©ºé—´åˆ†é…æ–¹æ³•è¿›è¡Œåˆ†é…ï¼Œè¿™æ—¶å€™è¾“å…¥æ–‡ä»¶ä¸­çš„å„ä¸ªæ®µåœ¨é“¾æ¥åçš„æ–‡ä»¶ ab ä¸­çš„è™šæ‹Ÿåœ°å€ä¹Ÿå°±å·²ç»ç¡®å®šäº†ï¼Œæ¯”å¦‚ **`.text`** æ®µèµ·å§‹åœ°å€ä¸º **`0x08049000`**ï¼Œ**`.data`** æ®µçš„èµ·å§‹åœ°å€ä¸º **`0x0804c00c`**ã€‚

å½“å‰é¢ä¸€æ­¥å®Œæˆä¹‹åï¼Œé“¾æ¥å™¨å¼€å§‹è®¡ç®—å„ä¸ªç¬¦å·çš„è™šæ‹Ÿåœ°å€ã€‚**<font color="red">å› ä¸ºå„ä¸ªç¬¦å·åœ¨æ®µå†…çš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥è¿™æ—¶å€™å…¶å® mainã€shared å’Œ swap çš„åœ°å€ä¹Ÿå·²ç»æ˜¯ç¡®å®šçš„äº†ï¼Œåªä¸è¿‡é“¾æ¥å™¨éœ€è¦ç»™æ¯ä¸ªç¬¦å·åŠ ä¸Šä¸€ä¸ªåç§»é‡ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿè°ƒæ•´åˆ°æ­£ç¡®çš„è™šæ‹Ÿåœ°å€</font>**ã€‚

<div align="center">
    <img src="é™æ€é“¾æ¥_static//1.png" width="300"/>
</div>

æ¯”å¦‚æˆ‘å‡è®¾ a.o ä¸­çš„ main å‡½æ•°ç›¸å¯¹äº **`a.o`** çš„ **`.text`** æ®µçš„åç§»æ˜¯ Xï¼Œä½†æ˜¯ç»è¿‡é“¾æ¥åˆå¹¶ä»¥åï¼Œa.o çš„ **`.text`** æ®µä½äºè™šæ‹Ÿåœ°å€ **`0x08049000`**ï¼Œé‚£ä¹ˆ main çš„åœ°å€åº”è¯¥æ˜¯ **`0x08049000+X`**ã€‚ä»ä¸Šé¢çš„è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œmain å‡½æ•°ä½äº **`a.o`** çš„ **`.text`** æ®µçš„æœ€å¼€å§‹ï¼Œä¹Ÿå°±æ˜¯åç§»ä¸º 0ï¼Œå³åœ¨æœ€ç»ˆçš„è¾“å‡ºæ–‡ä»¶ ab ä¸­çš„åœ°å€åº”è¯¥æ˜¯ **`0x08049000+0`**ã€‚ç„¶åæ¥ç€æ˜¯ **`__x86.get_pc_thunk.ax`** æ®µï¼Œç”±äº **`a.o`** ä¸­ **`.text`** æ®µçš„å¤§å°ä¸º 0x4aï¼Œå› æ­¤ **`__x86.get_pc_thunk.ax`** æ®µåœ¨ ab æ–‡ä»¶ä¸­çš„åœ°å€ä¸º **`0x0804904a`**ã€‚swap å‡½æ•°ä½äº **`b.o`** çš„ **`.text`** æ®µçš„æœ€å¼€å§‹ï¼Œåç§»é‡ä¹Ÿä¸º 0ï¼Œè€Œ b.o ä¸­çš„ **`.text`** æ®µåœ¨ **`__x86.get_pc_thunk.ax`** ä¹‹åï¼Œå› æ­¤ swap å‡½æ•°çš„åœ°å€ä¸º **`0x0804904a+4=0x0804904e`**ã€‚

<div align="center">
    <img src="é™æ€é“¾æ¥_static//2.png" width="300"/>
</div>

shared å˜é‡åœ¨ **`b.o`** çš„ **`.data`** æ®µçš„æœ€å¼€å§‹ï¼Œä¹Ÿå°±æ˜¯åç§»ä¸º 0ï¼Œå¹¶ä¸” **`b.o`** çš„ **`.data`** æ®µä½äº ab æ–‡ä»¶ä¸­çš„ **`0x0804c00c`** åœ°å€å¤„ï¼ˆa.o æ–‡ä»¶ä¸­ **`.data`** æ®µçš„å¤§å°ä¸º 0ï¼‰ã€‚å› æ­¤ shared å˜é‡åœ¨ ab æ–‡ä»¶ä¸­çš„åœ°å€ä¸º **`0x0804c00c+0=0x0804c00c`**ã€‚

```c{.line-numbers}
monica@monica-virtual-machine:~/linkers_loaders$ readelf -s a.o | grep main
     4: 00000000    74 FUNC    GLOBAL DEFAULT    2 main
monica@monica-virtual-machine:~/linkers_loaders$ readelf -s ab | grep main
     9: 08049000    74 FUNC    GLOBAL DEFAULT    1 main

monica@monica-virtual-machine:~/linkers_loaders$ readelf -s ab | grep ax
     6: 0804904a     0 FUNC    GLOBAL HIDDEN     1 __x86.get_pc_thunk.ax

monica@monica-virtual-machine:~/linkers_loaders$ readelf -s b.o | grep swap
     5: 00000000    67 FUNC    GLOBAL DEFAULT    2 swap
monica@monica-virtual-machine:~/linkers_loaders$ readelf -s ab | grep swap
     5: 0804904e    67 FUNC    GLOBAL DEFAULT    1 swap

monica@monica-virtual-machine:~/linkers_loaders$ readelf -s b.o | grep shared
     4: 00000000     4 OBJECT  GLOBAL DEFAULT    4 shared
monica@monica-virtual-machine:~/linkers_loaders$ readelf -s ab | grep shared
     7: 0804c00c     4 OBJECT  GLOBAL DEFAULT    4 shared
```

## 2.ç¬¦å·è§£æä¸é‡å®šä½

### 2.1 é‡å®šä½

å¯¹äºåŒæ ·çš„ a.c æ–‡ä»¶ï¼Œåœ¨ç¼–è¯‘æ—¶ä½¿ç”¨ **`-fno-pic`** é€‰é¡¹ï¼Œè¦æ±‚ç¼–è¯‘å™¨ä¸è¦ç”Ÿæˆä½ç½®æ— å…³ä»£ç ï¼Œè®¿é—®å…¨å±€å˜é‡å’Œå‡½æ•°æ—¶å°½é‡ä½¿ç”¨ç»å¯¹åœ°å€ã€‚ç„¶åä½¿ç”¨ **`objdump -d`** æŸ¥çœ‹ a.o ä»£ç åæ±‡ç¼–çš„ç»“æœï¼š

```c{.line-numbers}
monica@monica-virtual-machine:~/linkers_loaders$ gcc -c a.c -m32 -fno-stack-protector -fno-PIC
monica@monica-virtual-machine:~/linkers_loaders$ objdump -drwC a.o
a.oï¼š     æ–‡ä»¶æ ¼å¼ elf32-i386
Disassembly of section .text:

00000000 <main>:
   0:	8d 4c 24 04          	leal    4(%esp), %ecx
   4:	83 e4 f0             	andl    $-16, %esp
   7:	ff 71 fc             	pushl	-4(%ecx)
   a:	55                   	pushl	%ebp
   b:	89 e5                	movl	%esp, %ebp
   d:	51                   	pushl	%ecx
   e:	83 ec 14             	subl	$20, %esp
  11:	c7 45 f4 64 00 00 00 	movl	$100, -12(%ebp)
  18:	83 ec 08             	subl	$8, %esp
  1b:	68 00 00 00 00       	pushl	$shared	            1c: R_386_32	shared
  20:	8d 45 f4             	leal	-12(%ebp), %eax
  23:	50                   	pushl	%eax
  24:	e8 fc ff ff ff       	call	swap	            25: R_386_PC32	swap
  29:	83 c4 10             	addl	$16, %esp
  2c:	b8 00 00 00 00       	movl	$0, %eax
  31:	8b 4d fc             	movl	-4(%ebp), %ecx
  34:	c9                   	leave  
  35:	8d 61 fc             	leal	-4(%ecx), %esp
  38:	c3                   	ret  
```

æˆ‘ä»¬çŸ¥é“åœ¨ç¨‹åºçš„ä»£ç é‡Œé¢ä½¿ç”¨çš„éƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼Œåœ¨è¿™é‡Œä¹Ÿå¯ä»¥çœ‹åˆ° main çš„èµ·å§‹åœ°å€ä¸º **`0x00000000`**ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æœªè¿›è¡Œå‰é¢æåˆ°çš„ç©ºé—´åˆ†é…ä¹‹å‰ï¼Œç›®æ ‡æ–‡ä»¶ä»£ç æ®µä¸­çš„èµ·å§‹åœ°å€ä»¥ **`0x00000000`** å¼€å§‹ï¼Œç­‰åˆ°ç©ºé—´åˆ†é…å®Œæˆä»¥åï¼Œå„ä¸ªå‡½æ•°æ‰ä¼šç¡®å®šè‡ªå·±åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„ä½ç½®ã€‚

å½“æºä»£ç  a.c åœ¨è¢«ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶æ—¶ï¼Œç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“ shared å’Œ swap çš„åœ°å€ï¼Œå› ä¸ºå®ƒä»¬å®šä¹‰åœ¨å…¶ä»–ç›®æ ‡æ–‡ä»¶ä¸­ã€‚æ‰€ä»¥ç¼–è¯‘å™¨å°±æš‚æ—¶æŠŠåœ°å€ 0 çœ‹ä½œæ˜¯ shared çš„åœ°å€ã€‚å¯ä»¥çœ‹åˆ°å¯¹ **`pushl $shared`** å‘½ä»¤æ¥è¯´ï¼Œå…³äº shared çš„åœ°å€éƒ¨åˆ†ä¸º **`0x00000000`**ã€‚

```c{.line-numbers}
1b:	68 00 00 00 00       	pushl	$shared	            1c: R_386_32	shared
```

å¦å¤–ä¸€ä¸ªæ˜¯ **`call swap`** è°ƒç”¨æŒ‡ä»¤ï¼Œå®ƒå…¶å®å°±è¡¨ç¤ºå¯¹ swap å‡½æ•°çš„è°ƒç”¨ï¼Œè¿™æ¡æŒ‡ä»¤å…±æœ‰ 5 ä¸ªå­—èŠ‚ï¼Œå‰é¢çš„ 0xE8 æ˜¯æ“ä½œç ï¼Œä» Intel çš„ IA-32 ä½“ç³»è½¯ä»¶å¼€å‘è€…æ‰‹å†Œå¯ä»¥æŸ¥é˜…åˆ°ï¼Œ**<font color="red">è¿™æ¡æŒ‡ä»¤æ˜¯ä¸€æ¡è¿‘å€ç›¸å¯¹ä½ç§»è°ƒç”¨æŒ‡ä»¤ï¼Œåé¢ 4 ä¸ªå­—èŠ‚å°±æ˜¯è¢«è°ƒç”¨å‡½æ•°çš„ç›¸å¯¹äºè°ƒç”¨æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åç§»é‡</font>**ã€‚åœ¨æ²¡æœ‰é‡å®šä½ä¹‹å‰ï¼Œç›¸å¯¹åç§»é‡ä¸º 0xFFFFFFFCï¼ˆå°ç«¯ï¼‰ï¼Œå®ƒæ˜¯å¸¸é‡ -4 çš„è¡¥ç å½¢å¼ã€‚ğŸ›©ï¸

```c{.line-numbers}
24:	e8 fc ff ff ff       	call	swap	            25: R_386_PC32	swap
```

**`call swap`** è°ƒç”¨æŒ‡ä»¤ä¸­çš„æœºå™¨ä»£ç ä¸º **`fc ff ff ff`**ï¼Œè¿™ä¹Ÿåªæ˜¯ä¸€ä¸ªä¸´æ—¶çš„å‡åœ°å€ï¼Œå› ä¸ºåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“ swap çš„çœŸæ­£åœ°å€ã€‚

**ç¼–è¯‘å™¨æŠŠè¿™ä¸¤æ¡æŒ‡ä»¤çš„åœ°å€éƒ¨åˆ†æš‚æ—¶ç”¨åœ°å€ `0x00000000` å’Œ `0xFFFFFFFC` ä»£æ›¿ç€ï¼ŒæŠŠçœŸæ­£çš„åœ°å€è®¡ç®—ä¸‹æ¥ç•™ç»™äº†é“¾æ¥å™¨**ã€‚æˆ‘ä»¬é€šè¿‡å‰é¢çš„ç©ºé—´ä¸åœ°å€åˆ†é…å¯ä»¥å¾—çŸ¥ï¼Œé“¾æ¥å™¨åœ¨å®Œæˆåœ°å€å’Œç©ºé—´åˆ†é…ä¹‹åå°±çŸ¥é“æ‰€æœ‰ç¬¦å·çš„è™šæ‹Ÿåœ°å€äº†ï¼Œé‚£ä¹ˆé“¾æ¥å™¨å°±å¯ä»¥æ ¹æ®ç¬¦å·çš„åœ°å€å¯¹æ¯ä¸ªéœ€è¦é‡å®šä½çš„æŒ‡ä»¤è¿›è¡Œåœ°å€ä¿®æ­£ã€‚æˆ‘ä»¬ç”¨ objdump æ¥åæ±‡ç¼–è¾“å‡ºç¨‹åº ab çš„ä»£ç æ®µï¼Œå¯ä»¥çœ‹åˆ° main å‡½æ•°çš„ä¸¤ä¸ªé‡å®šä½å…¥å£éƒ½å·²ç»è¢«ä¿®æ­£åˆ°æ­£ç¡®çš„ä½ç½®ï¼Œå¦‚ä½•ä¿®æ­£è¯·çœ‹åé¢çš„é‡å®šä½ç±»å‹ã€‚

```c{.line-numbers}
monica@monica-virtual-machine:~/linkers_loaders$ gcc -c b.c -m32 -fno-stack-protector -fno-PIC
monica@monica-virtual-machine:~/linkers_loaders$ ld a.o b.o -o ab -e main -m elf_i386 
monica@monica-virtual-machine:~/linkers_loaders$ objdump -dwrC ab

abï¼š     æ–‡ä»¶æ ¼å¼ elf32-i386
Disassembly of section .text:

08049000 <main>:
 8049000:	8d 4c 24 04          	lea    0x4(%esp),%ecx
 8049004:	83 e4 f0             	and    $0xfffffff0,%esp
 8049007:	ff 71 fc             	push   -0x4(%ecx)
 804900a:	55                   	push   %ebp
 804900b:	89 e5                	mov    %esp,%ebp
 804900d:	51                   	push   %ecx
 804900e:	83 ec 14             	sub    $0x14,%esp
 8049011:	c7 45 f4 64 00 00 00 	movl   $0x64,-0xc(%ebp)
 8049018:	83 ec 08             	sub    $0x8,%esp
 804901b:	68 00 c0 04 08       	push   $0x804c000
 8049020:	8d 45 f4             	lea    -0xc(%ebp),%eax
 8049023:	50                   	push   %eax
 8049024:	e8 10 00 00 00       	call   8049039 <swap>
 8049029:	83 c4 10             	add    $0x10,%esp
 804902c:	b8 00 00 00 00       	mov    $0x0,%eax
 8049031:	8b 4d fc             	mov    -0x4(%ebp),%ecx
 8049034:	c9                   	leave  
 8049035:	8d 61 fc             	lea    -0x4(%ecx),%esp
 8049038:	c3                   	ret  

08049039 <swap>:
```

### 2.2 é‡å®šä½è¡¨

**<font color="red">é‚£ä¹ˆé“¾æ¥å™¨æ˜¯æ€ä¹ˆçŸ¥é“å“ªäº›æŒ‡ä»¤æ˜¯è¦è¢«è°ƒæ•´çš„å‘¢ï¼Ÿè¿™äº›æŒ‡ä»¤çš„å“ªäº›éƒ¨åˆ†è¦è¢«è°ƒæ•´ï¼ˆé‡å®šä½è¦ä¿®æ”¹å“ªäº›ä½ç½®ï¼‰ï¼Ÿæ€ä¹ˆè°ƒæ•´ï¼ˆé‡å®šä½çš„è®¡ç®—æ–¹å¼ï¼‰ï¼Ÿ</font>**ï¼Œäº‹å®ä¸Šåœ¨ ELF æ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€ä¸ªå«é‡å®šä½è¡¨ï¼ˆRelocation Tableï¼‰ çš„ç»“æ„ä¸“é—¨ç”¨æ¥ä¿å­˜è¿™äº›ä¸é‡å®šä½ç›¸å…³çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬åœ¨å‰é¢ä»‹ç» ELF æ–‡ä»¶ç»“æ„æ—¶å·²ç»æåˆ°äº†é‡å®šä½è¡¨ï¼Œå®ƒåœ¨ ELF æ–‡ä»¶ä¸­å¾€å¾€æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªæ®µã€‚

å¯¹äºå¯é‡å®šä½çš„ ELF æ–‡ä»¶æ¥è¯´ï¼Œå®ƒå¿…é¡»åŒ…å«æœ‰é‡å®šä½è¡¨ï¼Œç”¨æ¥æè¿°å¦‚ä½•ä¿®æ”¹ç›¸åº”çš„æ®µé‡Œçš„å†…å®¹ã€‚**<font color="red">å¯¹æ¯ä¸ªè¦è¢«é‡å®šä½çš„ ELF æ®µéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„é‡å®šä½è¡¨ï¼Œè€Œä¸€ä¸ªé‡å®šä½è¡¨å¾€å¾€å°±æ˜¯ ELF æ–‡ä»¶ä¸­çš„ä¸€ä¸ªæ®µï¼Œæ‰€ä»¥å…¶å®é‡å®šä½è¡¨ä¹Ÿå¯ä»¥å«é‡å®šä½æ®µ</font>**ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œç»Ÿä¸€ç§°ä½œé‡å®šä½è¡¨ã€‚æ¯”å¦‚ä»£ç æ®µ **`.text`** å¦‚æœ‰è¦è¢«é‡å®šä½çš„åœ°æ–¹ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€ä¸ªç›¸å¯¹åº”å« **`.rel.text`** çš„æ®µä¿å­˜äº†ä»£ç æ®µçš„é‡å®šä½è¡¨ï¼›å¦‚æœä»£ç æ®µ **`.data`** æœ‰è¦è¢«é‡å®šä½çš„åœ°æ–¹ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªç›¸å¯¹åº”å« **`.rel.data`** çš„æ®µä¿å­˜äº†æ•°æ®æ®µçš„é‡å®šä½è¡¨ã€‚æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶ a.o çš„é‡å®šä½è¡¨ï¼š

```c{.line-numbers}
monica@monica-virtual-machine:~/linkers_loaders$ readelf -r a.o

é‡å®šä½èŠ‚ '.rel.text' at offset 0x158 contains 2 entries:
 åç§»é‡     ä¿¡æ¯    ç±»å‹              ç¬¦å·å€¼      ç¬¦å·åç§°
0000001c  00000401 R_386_32          00000000   shared
00000025  00000502 R_386_PC32        00000000   swap

monica@monica-virtual-machine:~/linkers_loaders$ objdump -r a.o

a.oï¼š     æ–‡ä»¶æ ¼å¼ elf32-i386
RELOCATION RECORDS FOR [.text]:
OFFSET   TYPE              VALUE 
0000001c R_386_32          shared
00000025 R_386_PC32        swap
```

æ¯ä¸ªè¦è¢«é‡å®šä½çš„åœ°æ–¹å«ä¸€ä¸ªé‡å®šä½å…¥å£ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° **`a.o`** é‡Œé¢æœ‰ä¸¤ä¸ªé‡å®šä½å…¥å£ã€‚é‡å®šä½å…¥å£çš„åç§»ï¼ˆOffsetï¼‰è¡¨ç¤ºè¯¥å…¥å£åœ¨è¦è¢«é‡å®šä½çš„æ®µä¸­çš„ä½ç½®ï¼Œ**<font color="red">`RELOCATION RECORDS FOR [.text]` è¡¨ç¤ºè¿™ä¸ªé‡å®šä½è¡¨æ˜¯ä»£ç æ®µçš„é‡å®šä½è¡¨ï¼Œæ‰€ä»¥åç§»è¡¨ç¤ºä»£ç æ®µä¸­é¡»è¦è¢«è°ƒæ•´çš„ä½ç½®</font>**ã€‚å¯¹ç…§å‰é¢çš„åæ±‡ç¼–ç»“æœå¯ä»¥çŸ¥é“ï¼Œè¿™é‡Œçš„ 0x1c å’Œ 0x25 åˆ†åˆ«å°±æ˜¯ä»£ç æ®µä¸­ mov æŒ‡ä»¤å’Œ call æŒ‡ä»¤çš„åœ°å€éƒ¨åˆ†ã€‚

å¯¹äº 32 ä½çš„ Intel x86 ç³»åˆ—å¤„ç†å™¨æ¥è¯´ï¼Œé‡å®šä½è¡¨çš„ç»“æ„ä¹Ÿå¾ˆç®€å•ï¼Œå®ƒæ˜¯ä¸€ä¸ª **`Elf32_Rel`** ç»“æ„çš„æ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„å…ƒç´ å¯¹åº”ä¸€ä¸ªé‡å®šä½å…¥å£ã€‚**`Elf32_Rel`** çš„å®šä¹‰å¦‚ä¸‹ï¼š

```c{.line-numbers}
typedef struct {
    Elf32_Addr r_offset;
    Elf32_Word r_info;
} Elf32_Rel;
```

- **`r_offset`**ï¼šé‡å®šä½å…¥å£çš„åç§»ã€‚å¯¹äºå¯é‡å®šä½æ–‡ä»¶æ¥è¯´ï¼Œè¿™ä¸ªå€¼æ˜¯è¯¥é‡å®šä½å…¥å£æ‰€è¦ä¿®æ­£çš„ä½ç½®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ç›¸å¯¹äºæ®µèµ·å§‹çš„åç§»ï¼›
- **`r_info`**ï¼šé‡å®šä½å…¥å£çš„ç±»å‹å’Œç¬¦å·ã€‚è¿™ä¸ªæˆå‘˜çš„ä½ 8 ä½è¡¨ç¤ºé‡å®šä½å…¥å£çš„ç±»å‹ï¼Œé«˜ 24 ä½è¡¨ç¤ºé‡å®šä½å…¥å£çš„ç¬¦å·åœ¨ç¬¦å·è¡¨ä¸­çš„ä¸‹æ ‡ï¼›

### 2.3 ç¬¦å·è§£æ

åœ¨æˆ‘ä»¬é€šå¸¸çš„è§‚å¿µé‡Œï¼Œä¹‹æ‰€ä»¥è¦é“¾æ¥æ˜¯å› ä¸ºç›®æ ‡æ–‡ä»¶ä¸­ç”¨åˆ°çš„ç¬¦å·è¦å®šä¹‰åœ¨å…¶ä»–ç›®æ ‡æ–‡ä»¶ï¼Œæ‰€ä»¥è¦å°†å®ƒä»¬é“¾æ¥èµ·æ¥ã€‚æ¯”å¦‚æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ ld æ¥é“¾æ¥ a.oï¼Œè€Œä¸å°† b.o ä½œä¸ºè¾“å…¥ã€‚é“¾æ¥å™¨å°±ä¼šå‘ç° shared å’Œ swap ä¸¤ä¸ªç¬¦å·æ²¡æœ‰è¢«å®šä¹‰ï¼Œæ²¡æœ‰åŠæ³•å®Œæˆé“¾æ¥å·¥ä½œï¼š

```c{.line-numbers}
monica@monica-virtual-machine:~/linkers_loaders$ ld a.o
ld: i386 architecture of input file `a.o' is incompatible with i386:x86-64 output
ld: è­¦å‘Š: æ— æ³•æ‰¾åˆ°é¡¹ç›®ç¬¦å· _start; ç¼ºçœä¸º 0000000000401000
ld: a.o: in function `main':
a.c:(.text+0x1c): undefined reference to `shared'
ld: a.c:(.text+0x25): undefined reference to `swap'
```

è¿™ä¹Ÿæ˜¯æˆ‘ä»¬å¹³æ—¶åœ¨ç¼–å†™ç¨‹åºçš„æ—¶å€™æœ€å¸¸ç¢°åˆ°çš„é—®é¢˜ä¹‹ä¸€ï¼Œå°±æ˜¯é“¾æ¥æ—¶ç¬¦å·æœªå®šä¹‰ã€‚å¯¼è‡´è¿™ä¸ªé—®é¢˜çš„åŸå› å¾ˆå¤šï¼Œæœ€å¸¸è§çš„ä¸€èˆ¬éƒ½æ˜¯é“¾æ¥æ—¶ç¼ºå°‘äº†æŸä¸ªåº“ï¼Œæˆ–è€…è¾“å…¥ç›®æ ‡æ–‡ä»¶è·¯å¾„ä¸æ­£ç¡®æˆ–ç¬¦å·çš„å£°æ˜ä¸å®šä¹‰ä¸ä¸€æ ·ã€‚å…¶å®é‡å®šä½è¿‡ç¨‹ä¹Ÿä¼´éšç€ç¬¦å·è§£æè¿‡ç¨‹ï¼Œæ¯ä¸ªç›®æ ‡æ–‡ä»¶éƒ½å¯èƒ½å®šä¹‰ä¸€äº›ç¬¦å·ï¼Œä¹Ÿå¯èƒ½å¼•ç”¨åˆ°å®šä¹‰åœ¨å…¶ä»–ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·ã€‚é‚£ä¹ˆå½“é“¾æ¥å™¨é‡åˆ°æŸä¸ªç¬¦å·å¼•ç”¨è¿›è¡Œé‡å®šä½æ—¶ï¼Œå®ƒå°±è¦ç¡®å®šè¿™ä¸ªç¬¦å·çš„çœŸå®åœ°å€ã€‚è¿™æ—¶å€™é“¾æ¥å™¨å°±ä¼šå»æŸ¥æ‰¾ç”±æ‰€æœ‰è¾“å…¥ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ç»„æˆçš„å…¨å±€ç¬¦å·è¡¨ï¼Œæ‰¾åˆ°ç›¸åº”çš„ç¬¦å·åè¿›è¡Œé‡å®šä½ã€‚

```c{.line-numbers}
monica@monica-virtual-machine:~/linkers_loaders$ readelf -s a.o

Symbol table '.symtab' contains 6 entries:
   Num:    Value  Size Type    Bind   Vis      Ndx Name
     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 00000000     0 FILE    LOCAL  DEFAULT  ABS a.c
     2: 00000000     0 SECTION LOCAL  DEFAULT    1 .text
     3: 00000000    57 FUNC    GLOBAL DEFAULT    1 main
     4: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND shared
     5: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND swap
```

GLOBAL ç±»å‹çš„ç¬¦å·ï¼Œé™¤äº† main å‡½æ•°æ˜¯å®šä¹‰åœ¨ä»£ç æ®µä¹‹å¤–ï¼Œå…¶ä»–ä¸¤ä¸ª shared å’Œ swap éƒ½æ˜¯ UNDï¼Œå³ undefined æœªå®šä¹‰ç±»å‹ï¼Œ**è¿™ç§æœªå®šä¹‰çš„ç¬¦å·éƒ½æ˜¯å› ä¸ºè¯¥ç›®æ ‡æ–‡ä»¶ä¸­æœ‰å…³äºå®ƒä»¬çš„é‡å®šä½é¡¹**ã€‚æ‰€ä»¥åœ¨é“¾æ¥å™¨æ‰«æå®Œæ‰€æœ‰çš„è¾“å…¥ç›®æ ‡æ–‡ä»¶ä¹‹åï¼Œ**æ‰€æœ‰è¿™äº›æœªå®šä¹‰çš„ç¬¦å·éƒ½åº”è¯¥èƒ½å¤Ÿåœ¨å…¨å±€ç¬¦å·è¡¨ä¸­æ‰¾åˆ°ï¼Œå¦åˆ™é“¾æ¥å™¨å°±æŠ¥ç¬¦å·æœªå®šä¹‰é”™è¯¯**ã€‚

