# 静态链接

## 1.空间和地址分配

### 1.1 相似段合并

对于链接器来说，整个链接过程中，它就是将几个输入目标文件加工后合并成一个输出文件。对于多个输入目标文件，链接器将相同性质的段合并到一起，比如将所有输入文件的 **`.text`** 合并到输出文件的 **`.text`** 段，接着是 **`.data`** 段、**`.bss`** 段等。**`.bss`** **<font color="red">段在目标文件和可执行文件中并不占用文件的空间，但是它在装载时占用地址空间</font>**。所以链接器在合并各个段的同时，也将 **`.bss`** 合并，并且分配虚拟空间。

现在链接器一般都采用一种叫 **两步链接（Two-pass Linking）** 的方法。也就是说整个链接过程分两步。

- **空间与地址分配**：扫描所有的输入目标文件，并且获得它们的各个段的长度、属性和位置，并且将输入目标文件中的符号表中所有的符号定义和符号引用收集起来，统一放到一个全局符号表。这一步中，链接器将能够获得所有输入目标文件的段长度，并且将它们合并，计算出输出文件中各个段合并后的长度与位置，并建立映射关系。
- **符号解析与重定位**：使用上面第一步中收集到的所有信息，读取输入文件中段的数据、重定位信息，并且进行符号解析与重定位，调整代码中的地址等。事实上第二步是链接过程的核心，特别是重定位过程。

```c{.line-numbers}
monica@monica-virtual-machine:~/linkers_loaders$ readelf -S a.o
There are 14 section headers, starting at offset 0x298:

节头：
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .group            GROUP           00000000 000034 000008 04     11   5  4
  [ 2] .text             PROGBITS        00000000 00003c 00004a 00  AX  0   0  1
  [ 3] .rel.text         REL             00000000 0001ec 000020 08   I 11   2  4
  [ 4] .data             PROGBITS        00000000 000086 000000 00  WA  0   0  1
  [ 5] .bss              NOBITS          00000000 000086 000000 00  WA  0   0  1
  [ 6] .text.__x86.[...] PROGBITS        00000000 000086 000004 00 AXG  0   0  1
  [ 7] .comment          PROGBITS        00000000 00008a 00002c 01  MS  0   0  1
  [ 8] .note.GNU-stack   PROGBITS        00000000 0000b6 000000 00      0   0  1
  [ 9] .eh_frame         PROGBITS        00000000 0000b8 000060 00   A  0   0  4
  [10] .rel.eh_frame     REL             00000000 00020c 000010 08   I 11   9  4
  [11] .symtab           SYMTAB          00000000 000118 000090 10     12   4  4
  [12] .strtab           STRTAB          00000000 0001a8 000042 00      0   0  1
  [13] .shstrtab         STRTAB          00000000 00021c 00007a 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  D (mbind), p (processor specific)

monica@monica-virtual-machine:~/linkers_loaders$ readelf -S b.o
There are 14 section headers, starting at offset 0x250:

节头：
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .group            GROUP           00000000 000034 000008 04     11   7  4
  [ 2] .text             PROGBITS        00000000 00003c 000022 00  AX  0   0  1
  [ 3] .rel.text         REL             00000000 0001b4 000010 08   I 11   2  4
  [ 4] .data             PROGBITS        00000000 000060 000004 00  WA  0   0  4
  [ 5] .bss              NOBITS          00000000 000064 000004 00  WA  0   0  4
  [ 6] .text.__x86.[...] PROGBITS        00000000 000064 000004 00 AXG  0   0  1
  [ 7] .comment          PROGBITS        00000000 000068 00002c 01  MS  0   0  1
  [ 8] .note.GNU-stack   PROGBITS        00000000 000094 000000 00      0   0  1
  [ 9] .eh_frame         PROGBITS        00000000 000094 00004c 00   A  0   0  4
  [10] .rel.eh_frame     REL             00000000 0001c4 000010 08   I 11   9  4
  [11] .symtab           SYMTAB          00000000 0000e0 000090 10     12   4  4
  [12] .strtab           STRTAB          00000000 000170 000041 00      0   0  1
  [13] .shstrtab         STRTAB          00000000 0001d4 00007a 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  D (mbind), p (processor specific)

monica@monica-virtual-machine:~/linkers_loaders$ readelf -S ab
There are 10 section headers, starting at offset 0x31b8:

节头：
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .text             PROGBITS        08049000 001000 000070 00  AX  0   0  1
  [ 2] .eh_frame         PROGBITS        0804a000 002000 000080 00   A  0   0  4
  [ 3] .got.plt          PROGBITS        0804c000 003000 00000c 04  WA  0   0  4
  [ 4] .data             PROGBITS        0804c00c 00300c 000004 00  WA  0   0  4
  [ 5] .bss              NOBITS          0804c010 003010 000004 00  WA  0   0  4
  [ 6] .comment          PROGBITS        00000000 003010 00002b 01  MS  0   0  1
  [ 7] .symtab           SYMTAB          00000000 00303c 0000d0 10      8   5  4
  [ 8] .strtab           STRTAB          00000000 00310c 000062 00      0   0  1
  [ 9] .shstrtab         STRTAB          00000000 00316e 000048 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (link order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  D (mbind), p (processor specific)
```