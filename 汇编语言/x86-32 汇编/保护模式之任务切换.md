# 任务切换

## 一、前言

### 1.简介

从 80286 开始的处理器是面向多任务系统而设计的。在一个多任务的环境中，可以同时存在多个任务，**每个任务都有各自的局部描述符表 (LDT) 和任务状态段 (TSS)**。在局部描述符表中存放着专属于任务局部/私有空间的段的描述符。可以在多个任务之间切换，使它们轮流执行，从一个任务切换到另一个任务时，具体的切换过程是由处理器固件负责进行的。

有两种基本的任务切换方式，一种是协同式的，从一个任务切换到另一个任务，需要当前任务主动地请求暂时放弃执行权，或者在通过调用门请求操作系统服务时，由操作系统"趁机"将控制转移到另一个任务。这种方式依赖于每个任务的"自律"性，当一个任务失控时，其他任务可能得不到执行的机会。

另一种是抢占式的，在这种方式下，**可以安装一个定时器中断，并在中断服务程序中实施任务切换**。硬件中断信号总会定时出现，不管处理器当时在做什么，中断都会适时地发生，而任务切换也就能够顺利进行。在这种情况下，每个任务都能获得平等的执行机会。

如下图所示，**所有任务共享一个全局空间，这是内核或者操作系统提供的**，包含了系统服务程序和数据；同时，每个任务还有自己的局部空间，每个任务的功能都不一样，所以局部空间包含的是一个任务区别于其他任务的私有代码和数据。

<div align="center">
    <img src="x86-32汇编保护模式_static//60.png" width="450"/>
</div>

在一个任务内，全局空间和局部空间具有不同的特权级别。如上图所示，使用调用门，可以在任务内将控制从 3 特权级的局部空间转移到 0 特权级的全局空间，以使用内核或者操作系统提供的服务。

任务切换是以任务为单位的，是指离开一个任务，转到另一个任务中去执行。**<font color="red">当一个任务正在执行时，处理器的各个部分都和该任务息息相关：段寄存器指向该任务所使用的内存段；通用寄存器保存着该任务的中间结果</font>**，等等。离开当前任务，转到另一个任务开始执行时，要保存旧任务的各种状态，并恢复新任务的运行环境。

在《任务和特权级保护》这一章中，一开始，处理器是在任务的全局空间（特权级为 0）执行的，然后通过一个虚假的调用门返回，使处理器回到任务的局部空间（当前特权级降为 3）执行。事实上，这是没有必要的，当计算机加电之后，一旦进入保护模式，就直接创建和执行操作系统的 0 特权级任务（以完成一些管理和控制功能，比如提供一个界面和用户进行交互）。**然后可以从该任务切换到其他任务，不管它们是哪个特权级别的**。

### 2.多任务

To provide efficient, protected multitasking, the 80386 employs several special data structures. It does not, however, use special instructions to control multitasking; **<font color="red">_instead, it interprets ordinary control-transfer instructions differently when they refer to the special data structures_</font>**. The registers and data structures that support multitasking are:

- Task state segment（任务状态段）
- Task state segment descriptor（任务状态段描述符）
- Task register（任务寄存器）：TR 寄存器中保存任务状态段 TSS 描述符的选择子，并且将 TSS 描述符加载到 TR 高速缓存中；
- Task gate descriptor

With these structures the 80386 can rapidly switch execution from one task to another, saving the context of the original task so that the task can be restarted later.下面详细介绍任务切换的方法。

### 3.TSS 和 TSS 描述符

TSS 和 TSS 描述符的格式如下所示。如下图所示，TSS 内偏移 0 处是前一个任务的 TSS 描述符选择子。和 LDT 一样，必须在全局描述符表 (GDT) 中创建每个 TSS 的描述符。当系统中有多个任务同时存在时，可以从一个任务切换到另一个任务执行，此时称任务是嵌套的。被嵌套的任务用这个指针指向前一个任务，即嵌套它的那个任务，当控制返回前一个任务时，处理器需要这个指针来识别前一个任务。创建 TSS 时可以为 0。

**SS0、SS1 和 SS2 分别是 0、1 和 2 特权级的栈段选择子**，ESP0、ESP1 和 ESP2 分别是 0、1 和 2 特权级栈的栈顶指针。这些内容应当由任务的创建者填写，**<font color="red">且属于填写后一般不变的静态部分</font>**，当通过调用门进行特权级之间的控制转移时，处理器用这些信息来切换栈。CR3 和分页有关，此处一般由任务的创建者填写，如果没有使用分页，可以为 0。

<div align="center">
    <div align="center" style="color: #F14; font-size:13px; font-weight:bold">TSS 格式</div>
    <img src="x86-32汇编保护模式_static//64.png" width="330"/>
</div></p>
<div align="center">
    <div align="center" style="color: #F14; font-size:13px; font-weight:bold">TSS 描述符格式</div>
    <img src="x86-32汇编保护模式_static//65.png" width="480"/>
</div>



## 二、使用中断进行任务切换

**第一种任务切换的方法是借助于中断**，这也是现代抢占式多任务的基础。原因很简单，只要中断没有被屏蔽，它就能随时发生。**比如设定定时器中断，中断就能够以准确的时间间隔发生，可以用来强制实施任务切换**。在实模式下，内存最低地址端的 1KB 是中断向量表，保存着 256 个中断处理过程的段地址和偏移地址。当中断发生时，处理器把中断号乘以 4，作为表内偏移量访问中断向量表，从相应的位置取出中断处理过程的段地址和偏移地址，并转移到那里执行。

<div align="center" style="display: flex;">
    <div style="text-align: center; margin-right: 2px;">
    <div align="center" style="color: #F14; font-size:13px; font-weight:bold">IDT 中的中断门和陷阱门</div>
    <img src="x86-32汇编保护模式_static//7.png" width="450"/>
    </div>
    <div style="text-align: center; margin-right: 2px;">
    <div align="center" style="color: #F14; font-size:13px; font-weight:bold">IDT 中的任务门</div>
    <img src="x86-32汇编保护模式_static//63.png" width="450"/>
    </div>
</div>

在保护模式下，中断向量表不再使用，取而代之的是中断描述符表（Interrupt Descriptor Table, IDT）。IDT 和 GDT、LDT 均用于保存描述符。唯一不同的地方是，它保存的是门描述符，包括中断门、陷阱门和任务门这 3 种门描述符。当中断发生时，处理器用中断号乘以8 (因为每个描述符占 8 字节)，作为偏移量访问中断描述符表，取出门描述符。门描述符中有中断处理过程的代码段选择子和段内偏移量，这和调用门是一样的，如上面左图所示。

一般的中断处理可以使用中断门和陷阱门。调用门的工作原理只是从任务的局部空间转移到更高特权级的全局空间去执行，本质上是一种任务内的控制转移行为。**<font color="red">与此相同，中断门和陷阱门允许在任务内实施中断处理，转到全局空间去执行一些系统级的管理工作</font>**，本质上也是任务内的控制转移行为，其过程如上左图所示。

但是在中断发生时，**<font color="blue">如果该中断号对应的门是任务门，那么性质就截然不同了，必须进行任务切换</font>**。即要中断当前任务的执行，保护当前任务的现场并转换到另一个任务去执行，其过程如上右图所示。

IDT 表中保存的中断门、陷阱门、任务门描述符格式如下所示，任务门描述符中的主要成份是任务的 TSS 选择子。任务门用于在中断发生时执行任务切换，而执行任务切换时必须找到新任务的任务状态段 (TSS)。所以任务门应当指向任务的 TSS。为了指向任务的 TSS，只需要在任务门描述符中给出任务的 TSS 选择子就可以了。

任务门描述符中的 P 位指示该门是否有效，当 P 位为 0 时，不允许通过此门实施任务切换；**DPL 是任务门描述符的特权级，但是对因中断而发起的任务切换不起作用，处理器不按特权级施加任何保护。但是这并不意味着 DPL 字段没有用处，当以非中断的方式通过任务门实施任务切换时它就有用了**。


<div align="center">
    <div align="center" style="color: #F14; font-size:13px; font-weight:bold">中断门和陷阱门描述符格式</div>
    <img src="x86-32汇编保护模式_static//61.png" width="500"/>
</div>
<div align="center">
    <div align="center" style="color: #F14; font-size:13px; font-weight:bold">任务门描述符格式</div>
    <img src="x86-32汇编保护模式_static//62.png" width="500"/>
</div>

当中断发生时，处理器用中断号乘以 8 作为索引访问中断描述符表。当它发现这是个任务门 (描述符) 时，就知道应当发起任务切换。于是它取出任务门描述符；再从任务门描述符中取出新任务的 TSS 选择子；接着再用 TSS 选择子访问 GDT，取出新任务的 TSS 描述符。

在转到新任务执行前，处理器要先把当前任务的状态保存起来。当前任务的 TSS 是由任务寄存器 TR 的当前内容指向的，所以处理器把每个寄存器的快照保存到由 TR 指向的 TSS 中。然后处理器访问新任务的 TSS，从中恢复各个寄存器的内容，包括通用寄存器、标志寄存器 EFLAGS、段寄存器、指令指针寄存器 EIP、栈指针寄存器 ESP，以及局部描述符表寄存器 (LDTR) 等。最终任务寄存器 TR 指向新任务的 TSS，而处理器旋即开始执行新的任务。一旦新任务开始执行，处理器固件会自动将其 TSS 描述符的 B 位置 1，表示该任务的状态为忙。

