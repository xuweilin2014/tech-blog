# ç¨‹åºçš„åŠ¨æ€åŠ è½½å’Œæ‰§è¡Œä¹‹ä¸€

## ä¸€ã€MBR ä¸»å¼•å¯¼ç¨‹åºä»£ç 

MBR ä¸»å¼•å¯¼ç¨‹åºé¦–å…ˆå°† 0~4GB æ•°æ®æ®µæè¿°ç¬¦ã€MBR ä»£ç æ®µæè¿°ç¬¦ã€å†…æ ¸å †æ ˆæ®µæè¿°ç¬¦ã€æ–‡æœ¬æ¨¡å¼æ˜¾å­˜æ®µæè¿°ç¬¦è¿™ 5 ä¸ªæè¿°ç¬¦å®‰è£…åˆ° GDT è¡¨ä¸­ã€‚ç„¶åå°†æ•´ä¸ªå†…æ ¸ç¨‹åºè¯»å–åˆ°å†…å­˜ä¸­ï¼ˆèµ·å§‹åœ°å€ä¸º 0x00040000ï¼‰ï¼Œä»è€Œè·å–å†…æ ¸ç¨‹åºå†…éƒ¨çš„åˆ†æ®µç»“æ„ï¼ŒåŒ…æ‹¬å†…æ ¸å…¬ç”¨ä¾‹ç¨‹æ®µã€å†…æ ¸æ•°æ®æ®µã€å†…æ ¸ä»£ç æ®µï¼Œå¹¶åˆ†åˆ«ä¸ºå…¶åˆ›å»ºæ®µæè¿°ç¬¦ï¼Œå®‰è£…åˆ° GDT ä¸­ï¼Œæœ‰äº†è¿™äº›æ®µæè¿°ç¬¦ä½œä¸ºåŸºç¡€ï¼ŒMBR æ¥ä¸‹æ¥è·³è½¬åˆ° å†…æ ¸ç¨‹åºã€‚

```armasm{.line-numbers}
       ;ä»£ç æ¸…å•13-1
       ;æ–‡ä»¶åï¼šc13_mbr.asm
       ;æ–‡ä»¶è¯´æ˜ï¼šç¡¬ç›˜ä¸»å¼•å¯¼æ‰‡åŒºä»£ç  
       ;åˆ›å»ºæ—¥æœŸï¼š2011-10-28 22:35         
       
       ;è®¾ç½®å †æ ˆæ®µå’Œæ ˆæŒ‡é’ˆ
       ;å¸¸æ•°ï¼Œå†…æ ¸åŠ è½½çš„èµ·å§‹å†…å­˜åœ°å€
       core_base_address equ 0x00040000   
       ;å¸¸æ•°ï¼Œå†…æ ¸çš„èµ·å§‹é€»è¾‘æ‰‡åŒºå· 
       core_start_sector equ 0x00000001  
       
       ;åˆå§‹åŒ–æ ˆçš„åˆå§‹åœ°å€ä¸º 0x7C00ï¼Œcs å¯„å­˜å™¨çš„å€¼ä¸º 0
       mov ax,cs
       mov ss,ax
       mov sp,0x7c00

       ;è®¡ç®— GDT æ‰€åœ¨çš„é€»è¾‘æ®µåœ°å€
       ;GDT çš„ 32 ä½ç‰©ç†åœ°å€ï¼Œå³ 0x7e00
       mov eax,[cs:pgdt+0x7c00+0x02] 
       xor edx,edx
       mov ebx,16
       ;åˆ†è§£æˆ 16 ä½é€»è¾‘åœ°å€ï¼Œå•†ï¼ˆé€»è¾‘æ®µåœ°å€ï¼‰åœ¨ eax ä¸­ï¼Œä½™æ•°ï¼ˆåç§»åœ°å€ï¼‰åœ¨ edx ä¸­
       div ebx

       ;ä»¤ ds æŒ‡å‘ GDT æ‰€åœ¨é€»è¾‘æ®µåœ°å€ä»¥è¿›è¡Œåç»­æ“ä½œ
       mov ds,eax
       ;ebx æŒ‡å‘ GDT æ®µçš„åç§»åœ°å€
       mov ebx,edx

       ;è·³è¿‡ 0# å·æè¿°ç¬¦çš„æ§½ä½ï¼Œä»¥ä¸‹ä¸º MBR åœ¨ GDT ä¸­ä¸ºå†…æ ¸å®‰è£… 4 ä¸ªæè¿°ç¬¦
       ;åˆ›å»º 1# æè¿°ç¬¦ï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°æ®æ®µï¼Œå¯¹åº” 0~4GB çš„çº¿æ€§åœ°å€ç©ºé—´
       ;åŸºåœ°å€ä¸º 0ï¼Œæ®µç•Œé™ä¸º 0xFFFFF
       mov dword [ebx+0x08],0x0000ffff
       ;ç²’åº¦ä¸º 4KBï¼Œå­˜å‚¨å™¨æ®µæè¿°ç¬¦ï¼ˆè¯»å†™æƒé™ï¼‰
       mov dword [ebx+0x0c],0x00cf9200     

       ;åˆ›å»º 2# æè¿°ç¬¦ï¼Œè¿™æ˜¯å³ä¸»å¼•å¯¼ç¨‹åºï¼ˆMBRï¼‰ä»£ç çš„æè¿°ç¬¦
       ;åŸºåœ°å€ä¸º 0x00007c00ï¼Œç•Œé™ 0x1FF
       mov dword [ebx+0x10],0x7c0001ff
       ;ç²’åº¦ä¸º 1 ä¸ªå­—èŠ‚ï¼Œä»£ç æ®µæè¿°ç¬¦
       mov dword [ebx+0x14],0x00409800  

       ;åˆ›å»º 3# æè¿°ç¬¦ï¼Œå³ä¸ºå†…æ ¸åˆ›å»ºä¸€ä¸ªå †æ ˆæ®µçš„æè¿°ç¬¦
       ;åŸºåœ°å€ä¸º 0x00007C00ï¼Œç•Œé™ 0xFFFFE 
       mov dword [ebx+0x18],0x7c00fffe
       ;ç²’åº¦ä¸º 4KBï¼Œæ­¤å†…æ ¸å †æ ˆçš„åŒºåŸŸèŒƒå›´ä¸º 0x6C00~0x7BFF
       mov dword [ebx+0x1c],0x00cf9600
       
       ;åˆ›å»º 4# æè¿°ç¬¦ï¼Œå³å»ºç«‹ä¿æŠ¤æ¨¡å¼ä¸‹çš„æ˜¾ç¤ºç¼“å†²åŒºæè¿°ç¬¦
       ;åŸºåœ°å€ä¸º 0x000B8000ï¼Œç•Œé™ 0x07FFF 
       mov dword [ebx+0x20],0x80007fff
       ;ç²’åº¦ä¸ºå­—èŠ‚ 
       mov dword [ebx+0x24],0x0040920b
       
       ;åˆå§‹åŒ–æè¿°ç¬¦è¡¨å¯„å­˜å™¨ GDTR
       ;æè¿°ç¬¦è¡¨çš„ç•Œé™ä¸º 39ï¼ˆä» 0 å­—èŠ‚å¼€å§‹è®¡ç®—åç§»é‡ï¼‰
       mov word [cs:pgdt+0x7c00],39
       lgdt [cs:pgdt+0x7c00]

       ;å—æ¡¥èŠ¯ç‰‡å†…çš„ç«¯å£ï¼Œåœ¨è¿›å…¥ä¿æŠ¤æ¨¡å¼ä¹‹å‰ï¼Œä¸€å®šè¦æ‰“å¼€ A20 çº¿è·¯ï¼Œä»è€Œå¯ä»¥è®¿é—®æ›´é«˜çš„åœ°å€åŒºé—´
       in al,0x92                          
       or al,0000_0010B
       ;æ‰“å¼€ A20
       out 0x92,al                        
       ;ä¿æŠ¤æ¨¡å¼å’Œå®æ¨¡å¼ä¸‹çš„ä¸­æ–­å¤„ç†æœºåˆ¶ä¸åŒï¼Œå› æ­¤è¿™é‡Œç¦æ­¢å¯å±è”½ä¸­æ–­çš„å¤„ç†
       cli                                

       mov eax,cr0
       or eax,1
       ;è®¾ç½® PE ä½ï¼Œæ­£å¼è¿›å…¥ä¿æŠ¤æ¨¡å¼
       mov cr0,eax

       ;16 ä½çš„æè¿°ç¬¦é€‰æ‹©å­:32 ä½åç§»
       ;æ¸…æµæ°´çº¿å¹¶ä¸²è¡ŒåŒ–å¤„ç†å™¨
       jmp dword 0x0010:flush
       [bits 32]

flush:                                  
       ;åŠ è½½æ•°æ®æ®µ (0..4GB) é€‰æ‹©å­ï¼Œå¯ä»¥è®¿é—®æ‰€æœ‰çš„ç‰©ç†å†…å­˜åœ°å€
       mov eax,0x0008
       mov ds,eax

       ;åŠ è½½å †æ ˆæ®µé€‰æ‹©å­
       mov eax,0x0018
       mov ss,eax
       ;å †æ ˆæŒ‡é’ˆ esp åˆå§‹åŒ–ä¸º 0
       xor esp,esp
       
       ;ä»¥ä¸‹åŠ è½½å†…æ ¸ç¨‹åº
       ;è·å–å†…æ ¸ç¨‹åºåœ¨ç‰©ç†å†…å­˜çš„èµ·å§‹åœ°å€ 0x00040000
       mov edi,core_base_address
       ;è·å–å†…æ ¸ç¨‹åºåœ¨ç£ç›˜ä¸Šçš„èµ·å§‹é€»è¾‘æ‰‡åŒºå· 0x00000001
       mov eax,core_start_sector
       mov ebx,edi
       ;ä»¥ä¸‹è¯»å–ç¨‹åºçš„èµ·å§‹éƒ¨åˆ†ï¼ˆä¸€ä¸ªæ‰‡åŒºï¼‰ï¼Œè¯»å– eax æŒ‡æ˜çš„æ‰‡åŒºåˆ° ds:ebx æŒ‡å®šçš„å†…å­˜åŒºåŸŸ
       call read_hard_disk_0

       ;ä»¥ä¸‹åˆ¤æ–­å†…æ ¸ç¨‹åºæœ‰å¤šå¤§
       ;åœ¨å†…æ ¸ç¨‹åºçš„ç¬¬ 1~4 ä¸ªå­—èŠ‚æ˜¯å†…æ ¸ç¨‹åºå°ºå¯¸
       mov eax,[edi]
       xor edx,edx
       ;512 å­—èŠ‚æ¯æ‰‡åŒº
       mov ecx,512    
       ;æ‰‡åŒºæ•°é‡åœ¨ eax ä¸­ï¼Œä½™æ•°ï¼ˆä¸åˆ°ä¸€ä¸ªæ‰‡åŒºçš„å­—èŠ‚æ•°ï¼‰åœ¨ edx ä¸­
       div ecx

       or edx,edx
       ;å¦‚æœ edx ä¸ä¸º 0ï¼Œä¸” eax ä¸ä¸º 0ï¼Œè¯´æ˜åº”è¯¥è¯»å–çš„æ‰‡åŒºæ€»æ•°ä¸º eax + 1ï¼Œä½†æ˜¯å·²ç»è¯»å–äº†ç¨‹åºå¤´çš„ä¸€ä¸ªæ‰‡åŒºï¼Œå› æ­¤è¿˜åº”è¯»å– eax ä¸ªæ‰‡åŒº
       ;å¦‚æœ edx ä¸ä¸º 0ï¼Œä¸” eax ä¸º 0ï¼Œè¯´æ˜åº”è¯¥è¯»å–çš„æ‰‡åŒºæ€»æ•°ä¸º 1ï¼Œä¹‹å‰å·²ç»è¯»å–ï¼Œç›´æ¥è·³åˆ° setup
       jnz @1
       ;å¦‚æœ edx ä¸º 0ï¼Œä¸” eax ä¸ä¸º 0ï¼Œé‚£ä¹ˆåº”è¯¥è¯»å–çš„æ‰‡åŒºæ€»æ•°ä¸º eaxï¼Œå·²ç»è¯»äº†ä¸€ä¸ªæ‰‡åŒºï¼Œè¿˜åº”è¯¥è¯»å– eax - 1 ä¸ªæ‰‡åŒº
       dec eax
@1:
       ;è€ƒè™‘å®é™…é•¿åº¦ â‰¤512 ä¸ªå­—èŠ‚çš„æƒ…å†µ
       or eax,eax
       ;EAX=0 ? 
       jz setup

       ;è¯»å–å‰©ä½™çš„æ‰‡åŒº
       ;32 ä½æ¨¡å¼ä¸‹çš„ LOOP ä½¿ç”¨ ECX
       mov ecx,eax
       mov eax,core_start_sector
       ;ä»ä¸‹ä¸€ä¸ªé€»è¾‘æ‰‡åŒºæ¥ç€è¯»
       inc eax
@2:
       call read_hard_disk_0
       inc eax
       ;å¾ªç¯è¯»ï¼Œç›´åˆ°è¯»å®Œæ•´ä¸ªå†…æ ¸
       loop @2

setup:
       ;ä¸å¯ä»¥åœ¨ä»£ç æ®µå†…å¯»å€ pgdtï¼Œä½†å¯ä»¥é€šè¿‡ 4GB çš„æ•°æ®æ®µæ¥è®¿é—®
       ;esi ä¸º GDT çš„ç‰©ç†åŸºå€
       mov esi,[0x7c00+pgdt+0x02]

       ;å†…æ ¸ç¨‹åºæŒ‰ç…§ ç³»ç»Ÿå…¬ç”¨ä¾‹ç¨‹æ®µ -> æ ¸å¿ƒæ•°æ®æ®µ -> æ ¸å¿ƒä»£ç æ®µ è¿›è¡Œæ’åˆ—
       ;å»ºç«‹å…¬ç”¨ä¾‹ç¨‹æ®µæè¿°ç¬¦
       ;å†…æ ¸å…¬ç”¨ä¾‹ç¨‹ä»£ç æ®µèµ·å§‹æ±‡ç¼–åœ°å€
       mov eax,[edi+0x04]                 
       ;å†…æ ¸æ•°æ®æ®µæ±‡ç¼–åœ°å€
       mov ebx,[edi+0x08]                 
       sub ebx,eax
       ;å†…æ ¸å…¬ç”¨ä¾‹ç¨‹æ®µç•Œé™
       dec ebx                
       ;å†…æ ¸å…¬ç”¨ä¾‹ç¨‹æ®µåŸºåœ°å€ 
       add eax,edi
       ;å­—èŠ‚ç²’åº¦çš„ä»£ç æ®µæè¿°ç¬¦
       mov ecx,0x00409800
       ;eax=çº¿æ€§åŸºåœ°å€ã€ebx=æ®µç•Œé™ã€ecx=å±æ€§ã€è¿”å› edx:eax=å®Œæ•´çš„æè¿°ç¬¦
       call make_gdt_descriptor
       mov [esi+0x28],eax
       mov [esi+0x2c],edx

       ;å»ºç«‹æ ¸å¿ƒæ•°æ®æ®µæè¿°ç¬¦
       ;æ ¸å¿ƒæ•°æ®æ®µèµ·å§‹æ±‡ç¼–åœ°å€
       mov eax,[edi+0x08]                 
       ;æ ¸å¿ƒä»£ç æ®µæ±‡ç¼–åœ°å€
       mov ebx,[edi+0x0c]                  
       sub ebx,eax
       ;æ ¸å¿ƒæ•°æ®æ®µç•Œé™
       dec ebx                            
       ;æ ¸å¿ƒæ•°æ®æ®µåŸºåœ°å€
       add eax,edi                        
       ;å­—èŠ‚ç²’åº¦çš„æ•°æ®æ®µæè¿°ç¬¦
       mov ecx,0x00409200                  
       call make_gdt_descriptor
       mov [esi+0x30],eax
       mov [esi+0x34],edx 

       ;å»ºç«‹æ ¸å¿ƒä»£ç æ®µæè¿°ç¬¦
       ;æ ¸å¿ƒä»£ç æ®µèµ·å§‹æ±‡ç¼–åœ°å€
       mov eax,[edi+0x0c]                 
       ;ç¨‹åºæ€»é•¿åº¦
       mov ebx,[edi+0x00]                 
       sub ebx,eax
       ;æ ¸å¿ƒä»£ç æ®µç•Œé™
       dec ebx                            
       ;æ ¸å¿ƒä»£ç æ®µåŸºåœ°å€
       add eax,edi                        
       ;å­—èŠ‚ç²’åº¦çš„ä»£ç æ®µæè¿°ç¬¦
       mov ecx,0x00409800                 
       call make_gdt_descriptor
       mov [esi+0x38],eax
       mov [esi+0x3c],edx

       ;æè¿°ç¬¦è¡¨çš„ç•Œé™
       mov word [0x7c00+pgdt],63
       ;å°† GDT ä¿¡æ¯å†™åˆ° GDTR å¯„å­˜å™¨ä¸­                                   
       lgdt [0x7c00+pgdt]
       ;è·³è½¬åˆ°å†…æ ¸ç¨‹åºä¸­å¼€å§‹æ‰§è¡Œ
       jmp far [edi+0x10]
       

;ä»ç¡¬ç›˜è¯»å–ä¸€ä¸ªé€»è¾‘æ‰‡åŒº
;eax=é€»è¾‘æ‰‡åŒºå·
;ds:ebx=ç›®æ ‡ç¼“å†²åŒºåœ°å€
;è¿”å›ï¼šebx=ebx+512
read_hard_disk_0:                        

       push eax 
       push ecx
       push edx

       ;al å¯„å­˜å™¨ä¸º eax çš„æœ€ä½ 8 ä½ï¼Œå› æ­¤ä¸‹é¢çš„ mov al,1 ä¼šæ”¹å˜ eax å¯„å­˜å™¨çš„å€¼
       ;éœ€è¦å…ˆ push ä¿å­˜ eax å¯„å­˜å™¨çš„å€¼
       push eax
       ;è®¾ç½®è¦ä»ç£ç›˜ä¸­è¯»å–çš„é€»è¾‘æ‰‡åŒºæ•°é‡ï¼Œè¿™ä¸ªæ•°å€¼è¦å†™å…¥ 0x1f2 ç«¯å£
       mov dx,0x1f2
       mov al,1
       ;è®¾ç½®è¯»å–çš„æ‰‡åŒºæ•°
       out dx,al                       

       ;è®¾ç½®èµ·å§‹ LBA æ‰‡åŒºå·ï¼Œæ­¤æ‰‡åŒºå·ä¿å­˜åœ¨ eax å¯„å­˜å™¨ä¸­
       ;éœ€è¦å°† LBA æ‰‡åŒºå·åˆ†æˆ 4 æ®µï¼Œåˆ†åˆ«å†™å…¥ç«¯å£ 0x1f3ã€0x1f4ã€0x1f5 å’Œ 0x1f6 ç«¯å£
       inc dx                        
       pop eax
       ;LBA åœ°å€ 7~0
       out dx,al                       

       ;å°† LBA åœ°å€ 15~8 å·å†™åˆ° 0x1f4 ç«¯å£ä¸­
       inc dx                          
       mov cl,8
       shr eax,cl
       out dx,al

       ;å°† LBA åœ°å€ 23~16 å·å†™åˆ° 0x1f5 ç«¯å£ä¸­
       inc dx                          
       shr eax,cl
       out dx,al                       

       ;0x1f6
       inc dx                          
       shr eax,cl
       ;0x1f6 ç«¯å£çš„ä½ 4 ä½ç”¨äºå­˜æ”¾é€»è¾‘æ‰‡åŒºå·çš„ 24ï½27 ä½
       ;ç¬¬ 4 ä½ç”¨äºæŒ‡ç¤ºç¡¬ç›˜å·ï¼Œ0 è¡¨ç¤ºä¸»ç›˜ï¼Œ1 è¡¨ç¤ºä»ç›˜ã€‚é«˜ 3 ä½æ˜¯â€œ111â€ï¼Œè¡¨ç¤º LBA æ¨¡å¼
       or al,0xe0                     
       out dx,al

       ;å‘ç«¯å£ 0x1f7 å†™å…¥ 0x20ï¼Œè¯·æ±‚ç¡¬ç›˜è¯»
       inc dx                          
       mov al,0x20
       out dx,al

.waits:
       ;ç­‰å¾…è¯»å†™æ“ä½œå®Œæˆã€‚ç«¯å£ 0x1f7 æ—¢æ˜¯å‘½ä»¤ç«¯å£ï¼Œåˆæ˜¯çŠ¶æ€ç«¯å£ã€‚
       ;åœ¨é€šè¿‡è¿™ä¸ªç«¯å£å‘é€è¯»å†™å‘½ä»¤ä¹‹åï¼Œç¡¬ç›˜å°±å¼€å§‹è¯»å–æ•°æ®ï¼Œå®ƒå°† 0x1f7 ç«¯å£çš„ç¬¬ 7 ä½ç½® 1ï¼Œè¡¨æ˜è‡ªå·±å¾ˆå¿™
       ;ä¸€æ—¦ç¡¬ç›˜ç³»ç»Ÿå‡†å¤‡å°±ç»ªï¼Œå®ƒå†å°†æ­¤ä½æ¸…é›¶ï¼ŒåŒæ—¶å°†ç¬¬ 3 ä½ç½® 1ï¼Œæ„æ€æ˜¯å‡†å¤‡å¥½äº†ï¼Œè¯·æ±‚ä¸»æœºå‘é€æˆ–è€…æ¥æ”¶æ•°æ®
       in al,dx
       and al,0x88
       cmp al,0x08
       ;ä¸å¿™ï¼Œä¸”ç¡¬ç›˜å·²å‡†å¤‡å¥½æ•°æ®ä¼ è¾“
       jnz .waits

       ;0x1f0 æ˜¯ç¡¬ç›˜æ¥å£çš„æ•°æ®ç«¯å£ï¼Œè€Œä¸”è¿˜æ˜¯ä¸€ä¸ª 16 ä½ç«¯å£ã€‚ä¸€æ—¦ç¡¬ç›˜å‡†å¤‡å°±ç»ªï¼Œå°±å¯ä»¥è¿ç»­ä»è¿™ä¸ªç«¯å£å†™å…¥æˆ–è€…è¯»å–æ•°æ®
       ;æ€»å…±è¦è¯»å–çš„å­—æ•°
       mov ecx,256
       mov dx,0x1f0
.readw:
       in ax,dx
       mov [ebx],ax
       add ebx,2
       loop .readw

       pop edx
       pop ecx
       pop eax

       ret

;æ„é€ æè¿°ç¬¦
;è¾“å…¥ï¼šEAX=çº¿æ€§åŸºåœ°å€
;      EBX=æ®µç•Œé™
;      ECX=å±æ€§ï¼ˆå„å±æ€§ä½éƒ½åœ¨åŸå§‹ä½ç½®ï¼Œå…¶å®ƒæ²¡ç”¨åˆ°çš„ä½ç½®0ï¼‰ 
;è¿”å›ï¼šEDX:EAX=å®Œæ•´çš„æè¿°ç¬¦
make_gdt_descriptor:   

       mov edx,eax
       ;å°† eax ä¸­ä½ 16 ä½çš„çº¿æ€§åŸºåœ°å€å·¦ç§» 16 ä½ï¼Œå¹¶ä¸”å·¦ç§»è¿‡ç¨‹ä¸­å³è¾¹ç©ºå‡ºçš„ä½ç”¨ 0 å¡«å……
       shl eax,16                     
       ;æè¿°ç¬¦å‰ 32 ä½ (EAX) æ„é€ å®Œæ¯•
       or ax,bx                        

       ;æ¸…é™¤åŸºåœ°å€ä¸­æ— å…³çš„ä½
       and edx,0xffff0000              
       rol edx,8
       ;è£…é…åŸºå€çš„ 31~24 å’Œ 23~16 (80486+)
       ;0x0123456789abcdef ==> 0xefcdab8967452301
       ;0x01234567 ==> 0x67452301
       bswap edx                       

       and ebx 0x000f0000
       ;è£…é…æ®µç•Œé™çš„é«˜ 4 ä½
       or edx,ebx                      

       ;è£…é…å±æ€§
       or edx,ecx                       
       ret

                        ;GDT çš„ç•Œé™å€¼    
       pgdt             dw 0
                        ;GDT çš„ç‰©ç†åœ°å€    
                        dd 0x00007e00      
                            
       times 510-($-$$) db 0
                        db 0x55,0xaa
```

## äºŒã€å†…æ ¸ç¨‹åºä»£ç 

å†…æ ¸ç¨‹åºé¦–å…ˆæ˜¾ç¤º CPU å“ç‰Œä¿¡æ¯ï¼Œæ¥ç€è·³è½¬åˆ° load_relocate_program è°ƒç”¨è¿‡ç¨‹ï¼Œé¦–å…ˆè°ƒç”¨ allocate_memory ç¡®å®šåˆ†é…çš„å†…å­˜åœ°å€ï¼Œç„¶åå°†ç”¨æˆ·ç¨‹åºå…¨éƒ¨ä»ç£ç›˜è¯»å–åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”æ ¹æ®è¯»å–çš„ç”¨æˆ·ç¨‹åºæ®µç»“æ„ï¼ˆå¤´éƒ¨æ®µã€ä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆæ®µï¼‰ï¼Œç”Ÿæˆæ®µæè¿°ç¬¦å¹¶å®‰è£…åˆ° GDT ä¸­ï¼Œæœ€åæŠŠæè¿°ç¬¦é€‰æ‹©å­ä¿å­˜åˆ°ç”¨æˆ·ç¨‹åºå¤´éƒ¨ã€‚æ¥ç€ï¼Œå°†ç”¨æˆ·ç¨‹åºå¤´éƒ¨çš„è°ƒç”¨ä¾‹ç¨‹ç¬¦å·åæ›¿æ¢ä¸ºå†…æ ¸ä¸­çš„å…¥å£åœ°å€ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸º**ç¬¦å·åœ°å€é‡å®šä½**ï¼Œæœ€åè·³è½¬åˆ°ç”¨æˆ·ç¨‹åºå¼€å§‹æ‰§è¡Œã€‚

```armasm{.line-numbers}
       ;ä»£ç æ¸…å•13-2
       ;æ–‡ä»¶åï¼šc13_core.asm
       ;æ–‡ä»¶è¯´æ˜ï¼šä¿æŠ¤æ¨¡å¼å¾®å‹æ ¸å¿ƒç¨‹åº 
       ;åˆ›å»ºæ—¥æœŸï¼š2011-10-26 12:11

       ;ä»¥ä¸‹å¸¸é‡å®šä¹‰éƒ¨åˆ†ã€‚å†…æ ¸çš„å¤§éƒ¨åˆ†å†…å®¹éƒ½åº”å½“å›ºå®š
       ;å†…æ ¸ä»£ç æ®µé€‰æ‹©å­ï¼ˆåºå·ä¸º 7ï¼‰ 
       core_code_seg_sel     equ  0x38    
       ;å†…æ ¸æ•°æ®æ®µé€‰æ‹©å­ï¼ˆåºå·ä¸º 6ï¼‰
       core_data_seg_sel     equ  0x30
       ;ç³»ç»Ÿå…¬å…±ä¾‹ç¨‹ä»£ç æ®µçš„é€‰æ‹©å­ï¼ˆåºå·ä¸º 5ï¼‰ 
       sys_routine_seg_sel   equ  0x28
       ;è§†é¢‘æ˜¾ç¤ºç¼“å†²åŒºçš„æ®µé€‰æ‹©å­ï¼ˆåºå·ä¸º 4ï¼‰ 
       video_ram_seg_sel     equ  0x20
       ;å†…æ ¸å †æ ˆæ®µé€‰æ‹©å­ï¼ˆåºå·ä¸º 3ï¼‰
       core_stack_seg_sel    equ  0x18
       ;æ•´ä¸ª 0-4GB å†…å­˜çš„æ®µçš„é€‰æ‹©å­ï¼ˆåºå·ä¸º 1ï¼‰
       mem_0_4_gb_seg_sel    equ  0x08

       ;ä»¥ä¸‹æ˜¯ç³»ç»Ÿæ ¸å¿ƒçš„å¤´éƒ¨ï¼Œç”¨äºåŠ è½½æ ¸å¿ƒç¨‹åº
       ;æ ¸å¿ƒç¨‹åºæ€»é•¿åº¦ï¼Œä½äºåç§»åœ°å€ 0x00 å¤„ 
       core_length      dd core_end
       ;ç³»ç»Ÿå…¬ç”¨ä¾‹ç¨‹æ®µä½ç½®ï¼Œä½äºåç§»åœ°å€ 0x04 å¤„
       sys_routine_seg  dd section.sys_routine.start
       ;æ ¸å¿ƒæ•°æ®æ®µä½ç½®ï¼Œä½äºåç§»åœ°å€ 0x08 å¤„
       core_data_seg    dd section.core_data.start
       ;æ ¸å¿ƒä»£ç æ®µä½ç½®ï¼Œä½äºåç§»åœ°å€ 0x0C å¤„
       core_code_seg    dd section.core_code.start
       ;æ ¸å¿ƒä»£ç æ®µå…¥å£ç‚¹ï¼Œä½äºåç§»åœ°å€ 0x10 å¤„ï¼Œé«˜åœ°å€ä¸ºä»£ç æ®µåœ°å€ï¼Œå³ä»£ç æ®µçš„æ®µé€‰æ‹©å­
       core_entry       dd start
                        dw core_code_seg_sel

       [bits 32]

;=====================ğŸ³ç³»ç»Ÿå…¬å…±ä¾‹ç¨‹ä»£ç æ®µğŸ³=================================

SECTION sys_routine vstart=0                 

;å­—ç¬¦ä¸²æ˜¾ç¤ºä¾‹ç¨‹
;æ˜¾ç¤º 0 ç»ˆæ­¢çš„å­—ç¬¦ä¸²å¹¶ç§»åŠ¨å…‰æ ‡
;è¾“å…¥ï¼šDS:EBX=ä¸²åœ°å€
put_string:                                  
                                   
       push ecx
.getc:
       ;è¾“å…¥ï¼šds:ebx=ä¸²åœ°å€ï¼Œds æŒ‡å‘æ•°æ®æ®µçš„æ®µåœ°å€ï¼Œebx åˆå§‹å€¼æŒ‡å‘æ•°æ®æ®µä¸­å­—ç¬¦ä¸²
       mov cl,[ebx]
       ;cl=0ï¼Œå¦‚æœ cl=0 çš„è¯ï¼Œé‚£ä¹ˆè¯´æ˜æ•´ä¸ªè¦æ˜¾ç¤ºå­—ç¬¦ä¸²çš„ç»“æŸ
       or cl,cl
       ;å¦‚æœæ˜¾ç¤ºåˆ°å­—ç¬¦ä¸²çš„ç»“å°¾ï¼Œè¿”å›ä¸»ç¨‹åº
       jz .exit
       call put_char
       ;ä¸‹ä¸€ä¸ªå­—ç¬¦
       inc ebx
       jmp .getc

.exit:
       pop ecx
       ;æ®µé—´è¿”å›ï¼ŒRETF æŒ‡ä»¤ä¸ä»…æ¢å¤æŒ‡ä»¤æŒ‡é’ˆï¼ˆIP/EIPï¼‰ï¼Œè¿˜æ¢å¤ä»£ç æ®µå¯„å­˜å™¨ï¼ˆCSï¼‰ã€‚
       retf                               

;åœ¨å½“å‰å…‰æ ‡å¤„æ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œå¹¶æ¨è¿›å…‰æ ‡ï¼Œä»…ç”¨äºæ®µå†…è°ƒç”¨ 
;è¾“å…¥ï¼šCL=å­—ç¬¦ ASCII ç  
put_char:                                   
       ;ä½œç”¨æ˜¯æŠŠé€šç”¨å¯„å­˜å™¨å‹æ ˆï¼Œå¯„å­˜å™¨çš„å…¥æ ˆé¡ºåºä¾æ¬¡æ˜¯ï¼šEAX,ECX,EDX,EBX,ESP(åˆå§‹å€¼),EBP,ESI,EDI.
       pushad

       ;ä»¥ä¸‹ä¸¤æ®µä»£ç è·å–å½“å‰å…‰æ ‡ä½ç½®ï¼Œå³å…‰æ ‡å¯„å­˜å™¨çš„é«˜ 8 ä½å’Œä½ 8 ä½åˆ†åˆ«ä¿å­˜åˆ° ah å’Œ al ä¸­
       ;ç´¢å¼•å¯„å­˜å™¨çš„ç«¯å£å·æ˜¯ 0x3d4ï¼Œå¯ä»¥å‘å®ƒå†™å…¥ä¸€ä¸ªå€¼ï¼Œç”¨æ¥æŒ‡å®šå†…éƒ¨çš„æŸä¸ªå¯„å­˜å™¨ã€‚æ¯”å¦‚ï¼Œä¸¤ä¸ª 8 ä½çš„å…‰æ ‡å¯„å­˜å™¨ï¼Œå…¶ç´¢å¼•å€¼åˆ†åˆ«æ˜¯ 14 (0x0e) å’Œ 15 (0x0f)ï¼Œåˆ†åˆ«ç”¨äºæä¾›å…‰æ ‡ä½ç½®çš„é«˜ 8 ä½å’Œä½ 8 ä½ï¼›æŒ‡å®šå¯„å­˜å™¨åï¼Œéœ€è¦è¯»å†™æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ 0x3d5 æ¥è¿›è¡Œ
       mov dx,0x3d4
       mov al,0x0e
       ;ç´¢å¼•å¯„å­˜å™¨çš„ç«¯å£å·æ˜¯ 0x3d4ï¼Œå°† 0x0e çš„å€¼å†™å…¥æ­¤ç´¢å¼•å¯„å­˜å™¨ï¼ˆal -> dxï¼‰
       ;æŒ‡å®šæƒ³è¦è®¿é—®å…‰æ ‡å¯„å­˜å™¨ï¼ˆé«˜ 8 ä½ï¼‰
       out dx,al
       inc dx                             
       ;é«˜å­—
       in al,dx                           
       mov ah,al

       ;å–å½“å‰å…‰æ ‡ä½ç½®çš„ä½ 8 ä½åˆ°å¯„å­˜å™¨ al ä¸­
       dec dx                             
       mov al,0x0f
       out dx,al
       ;0x3d5
       inc dx                             
       in al,dx                           
       ;bx = ä»£è¡¨å…‰æ ‡ä½ç½®çš„ 16 ä½æ•°
       mov bx,ax                          

       ;åˆ¤æ–­è¦æ˜¾ç¤ºçš„å­—ç¬¦ cl æ˜¯å¦ä¸ºå›è½¦ç¬¦ï¼Ÿ
       cmp cl,0x0d     
       ;å¦‚æœä¸æ˜¯ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯æ¢è¡Œç­‰å­—ç¬¦                   
       jnz .put_0a
       ;å¦‚æœæ˜¯å›è½¦ï¼Œå°±å°†å½“å‰å…‰æ ‡è½¬ç§»åˆ°å½“å‰è¡Œè¡Œé¦–
       mov ax,bx
       mov bl,80
       ;æ¯è¡Œæœ‰ 80 ä¸ªå­—ç¬¦ï¼Œç”¨å½“å‰å…‰æ ‡çš„ä½ç½®é™¤ä»¥ 80ï¼Œå•† al å¯„å­˜å™¨ä¸­å°±æ˜¯å½“å‰å…‰æ ‡æ‰€åœ¨è¡Œå·
       div bl
       ;å°† al ä¸­çš„å†…å®¹ä¹˜ä»¥ bl ä¸­çš„ 80ï¼Œä¼šåœ¨ç»“æœ ax å¯„å­˜å™¨ä¸­å¾—åˆ°å½“å‰è¡Œè¡Œé¦–çš„å…‰æ ‡å€¼
       ;å­—èŠ‚ä¹˜æ³• mulï¼Œåˆ™ alÃ—REG8/MEM8ï¼Œä¹˜ç§¯å­˜äº ax ä¸­
       mul bl
       mov bx,ax
       jmp .set_cursor

  .put_0a:
       ;åˆ¤æ–­è¦æ˜¾ç¤ºçš„å­—ç¬¦ cl æ˜¯å¦ä¸ºæ¢è¡Œç¬¦ï¼Ÿ
       cmp cl,0x0a
       ;ä¸æ˜¯ï¼Œé‚£å°±æ­£å¸¸æ˜¾ç¤ºå­—ç¬¦
       jnz .put_other
       ;å¦‚æœæ˜¯æ¢è¡Œç¬¦ï¼Œå°±å°†å½“å‰çš„å…‰æ ‡ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œ
       ;å¦‚æœå½“å‰è¡Œåœ¨å±å¹•ä¸­æ˜¯æœ€åä¸€è¡Œï¼Œå°±éœ€è¦è¿›è¡Œæ»šå± 
       add bx,80
       jmp .roll_screen

  .put_other:                               
       ;æ­£å¸¸æ˜¾ç¤ºå­—ç¬¦ï¼Œåœ¨å†…å­˜ä¸­ï¼Œ0xB8000ï½0xBFFFF æ˜¯ç•™ç»™æ˜¾å¡çš„ï¼Œç”±æ˜¾å¡æ¥æ˜¾ç¤ºæ–‡æœ¬
       ;ä½¿ç”¨ es ä½œä¸ºæ˜¾å­˜å¯„å­˜å™¨ï¼Œæ®µåœ°å€ä¸º 0xb800ï¼Œåç§»åœ°å€ä¸º 0x0000~0x7FFF
       push es
       ;0xb8000 æ®µçš„é€‰æ‹©å­
       mov eax,video_ram_seg_sel
       mov es,eax
       ;ç”±äºä¸€ä¸ªå­—ç¬¦åœ¨æ˜¾å­˜ä¸­å¯¹åº”ä¸¤ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å¯ä»¥å°†å…‰æ ‡ä½ç½®ä¹˜ä»¥ 2 æ¥å¾—åˆ°è¯¥ä½ç½®åœ¨æ˜¾å­˜ä¸­çš„åç§»åœ°å€
       shl bx,1
       mov [es:bx],cl
       pop es

       ;ä»¥ä¸‹å°†å…‰æ ‡ä½ç½®æ¨è¿›ä¸€ä¸ªå­—ç¬¦
       shr bx,1
       inc bx

  .roll_screen:
       ;å…‰æ ‡è¶…å‡ºå±å¹•ï¼Ÿæ»šå±
       cmp bx,2000
       jl .set_cursor

       push ds
       push es
       ;0xb8000 æ®µçš„é€‰æ‹©å­
       mov eax,video_ram_seg_sel
       mov ds,eax
       mov es,eax
       ;ä» ds:esi ä¼ é€åˆ°çš„ç›®çš„åœ°å€ es:ediï¼Œå¹¶ä¸” cld è¡¨ç¤ºè¦è¿›è¡Œæ­£å‘ä¼ è¾“ï¼Œå³ä»ä½åœ°å€ä¼ é€åˆ°é«˜åœ°å€
       cld
       ;å°†å±å¹•ä¸Šç¬¬ 2~25 è¡Œçš„å†…å®¹æ•´ä½“å¾€ä¸Šæ 1 è¡Œï¼Œæœ€åç”¨é»‘åº•ç™½å­—çš„ç©ºç™½å­—ç¬¦å¡«å……ç¬¬ 25 è¡Œ
       mov esi,0xa0
       mov edi,0x00
       mov ecx,1920
       ;å°†å±å¹•ä¸Šç¬¬ 2~25 è¡Œçš„å†…å®¹æ•´ä½“å¾€ä¸Šæ 1 è¡Œï¼Œæœ€åç”¨é»‘åº•ç™½å­—çš„ç©ºç™½å­—ç¬¦å¡«å……ç¬¬ 25 è¡Œ
       rep movsw
       ;æ¸…é™¤å±å¹•æœ€åº•ä¸€è¡Œ
       mov bx,3840
       ;32 ä½ç¨‹åºåº”è¯¥ä½¿ç”¨ ECX
       mov ecx,80                         
  .cls:
       ;0x0720 ä¸­çš„ 0x20 è¡¨ç¤ºç©ºç™½å­—ç¬¦ï¼ˆSPACEï¼‰ï¼Œ0x07 è¡¨ç¤ºé»‘åº•ç™½å­—
       mov word [es:bx],0x0720
       add bx,2
       loop .cls

       pop es
       pop ds
       ;å°†å…‰æ ‡ç§»åˆ°è‡³æœ€åä¸€è¡Œçš„å¼€å¤´å¤„
       mov bx,1920

  .set_cursor:
       ;ä¸ç®¡æ˜¯å›è½¦ã€æ¢è¡Œï¼Œè¿˜æ˜¯æ˜¾ç¤ºå¯æ‰“å°å­—ç¬¦ï¼Œä¸Šé¢éƒ½ç»™å‡ºäº†å…‰æ ‡ä½ç½®çš„æ–°æ•°å€¼
       ;ä¸‹é¢å°±æ˜¯å°†æ–°çš„å…‰æ ‡ä½ç½®åœ¨å±å¹•ä¸Šæ˜¾ç¤ºå‡ºæ¥
       mov dx,0x3d4
       mov al,0x0e
       ;al -> dxï¼ŒæŒ‡å®šè¦è®¿é—®å…‰æ ‡å¯„å­˜å™¨ï¼ˆé«˜ 8 ä½ï¼‰
       out dx,al
       ;éœ€è¦å¾€å…‰æ ‡å¯„å­˜å™¨å†™æ•°æ®
       inc dx                             
       mov al,bh
       ;å°†å…‰æ ‡ä½ç½®çš„é«˜ 8 ä½å†™å…¥
       out dx,al
       dec dx                             
       mov al,0x0f
       ;al -> dxï¼ŒæŒ‡å®šè¦è®¿é—®å…‰æ ‡å¯„å­˜å™¨ï¼ˆä½ 8 ä½ï¼‰
       out dx,al
       inc dx                             
       mov al,bl
       ;å°†å…‰æ ‡ä½ç½®çš„ä½ 8 ä½å†™å…¥
       out dx,al

       popad
       ret                                

;ä»ç¡¬ç›˜è¯»å–ä¸€ä¸ªé€»è¾‘æ‰‡åŒº
;EAX=é€»è¾‘æ‰‡åŒºå·
;DS:EBX=ç›®æ ‡ç¼“å†²åŒºåœ°å€
;è¿”å›ï¼šEBX=EBX+512
read_hard_disk_0:                           
       push eax 
       push ecx
       push edx

       push eax
       
       mov dx,0x1f2
       mov al,1
       ;è¯»å–çš„æ‰‡åŒºæ•°
       out dx,al                          

       inc dx                             
       pop eax
       out dx,al

       inc dx
       mov cl,8
       shr eax,cl
       out dx,al

       inc dx   
       shr eax,cl
       out dx,al

       inc dx
       shr eax,cl
       or al,0xe0
       out dx,al

       inc dx
       mov al,0x20
       out dx,al

  .waits:
       in al,dx
       and al,0x88
       cmp al,0x08
       jnz .waits                          

       mov ecx,256
       mov dx,0x1f0
  .readw:
       in ax,dx
       mov [ebx],ax
       add ebx,2
       loop .readw

       pop edx
       pop ecx
       pop eax

       retf                               ;æ®µé—´è¿”å› 

      
;åˆ†é…å†…å­˜
;è¾“å…¥ï¼šECX=å¸Œæœ›åˆ†é…çš„å­—èŠ‚æ•°
;è¾“å‡ºï¼šECX=èµ·å§‹çº¿æ€§åœ°å€ 
allocate_memory:                            
       push ds
       push eax
       push ebx

       ;å°†å†…æ ¸æ•°æ®æ®µé€‰æ‹©å­å†™å…¥ eax ä¸­
       mov eax,core_data_seg_sel
       mov ds,eax

       ;è·å–å¯ç”¨äºå†…å­˜åˆ†é…çš„åˆå§‹å†…å­˜åœ°å€
       mov eax,[ram_alloc]
       ;å°† eax + åˆ†é…çš„å­—èŠ‚æ•°æ¥è®¡ç®—ä¸‹ä¸€æ¬¡åˆ†é…æ—¶çš„èµ·å§‹åœ°å€
       add eax,ecx                        
       ;åœ¨ ecx ä¸­å¾—åˆ°æœ¬æ¬¡åˆ†é…åˆ°çš„èµ·å§‹å†…å­˜åœ°å€ï¼Œå¹¶è¿”å›ç»™è°ƒç”¨è€…
       mov ecx,[ram_alloc]

       ;åœ¨ 32 ä½è®¡ç®—æœºä¸­ï¼Œåˆ†é…çš„å†…å­˜åœ°å€å»ºè®®ä¸º 4 å­—èŠ‚å¯¹é½çš„
       mov ebx,eax
       ;èƒ½å¤Ÿè¢« 4 æ•´é™¤çš„æ•°çš„ä½ 2 ä½å‡ä¸º 0ï¼Œä¸‹é¢å°† ebx ä¸­çš„å†…å­˜åœ°å€è¿›è¡Œ 4 å­—èŠ‚å¯¹é½
       and ebx,0xfffffffc
       add ebx,4         
       ;å¦‚æœåŸå…ˆ eax ä¸­çš„åœ°å€æ˜¯ 4 å­—èŠ‚å¯¹é½çš„ï¼Œé‚£ä¹ˆå°±ç›´æ¥ä½¿ç”¨ eax å†™å›å†…å­˜ä½œä¸ºä¸‹ä¸€æ¬¡åˆ†é…çš„èµ·å§‹åœ°å€
       ;å¦åˆ™ï¼Œå°±ä½¿ç”¨è®¡ç®—å‡ºæ¥çš„ 4 å­—èŠ‚å¯¹é½çš„ ebx ä½œä¸ºä¸‹ä¸€æ¬¡åˆ†é…çš„èµ·å§‹åœ°å€
       test eax,0x00000003                
       cmovnz eax,ebx                    
       mov [ram_alloc],eax               
                                           
       pop ebx
       pop eax
       pop ds

       retf

;åœ¨ gdt å†…å®‰è£…ä¸€ä¸ªæ–°çš„æè¿°ç¬¦
;è¾“å…¥ï¼šedx:eax=æè¿°ç¬¦ 
;è¾“å‡ºï¼šcx=æè¿°ç¬¦çš„é€‰æ‹©å­
set_up_gdt_descriptor:  

       push eax
       push ebx
       push edx
       push ds
       push es

       ;åˆ‡æ¢åˆ°æ ¸å¿ƒæ•°æ®æ®µ
       mov ebx,core_data_seg_sel
       mov ds,ebx
       ;sgdt m æŒ‡ä»¤ï¼Œå…¶ä¸­ m æ˜¯ä¸€ä¸ª 6 å­—èŠ‚çš„å†…å­˜åŒºåŸŸçš„é¦–åœ°å€
       ;ä»¥ä¾¿å¼€å§‹å¤„ç† GDTï¼Œå°† GDTR å¯„å­˜å™¨çš„åŸºåœ°å€å’Œè¾¹ç•Œä¿¡æ¯ä¿å­˜åˆ°æŒ‡å®šå†…å­˜ä½ç½®
       ;å°†ä½ 2 å­—èŠ‚ç”¨äºä¿å­˜ GDT çš„ç•Œé™ï¼Œé«˜ 4 å­—èŠ‚ç”¨äºä¿å­˜ GDT çš„ 32 ä½ç‰©ç†åœ°å€
       sgdt [pgdt]

       mov ebx,mem_0_4_gb_seg_sel
       mov es,ebx

       ;ä¸‹é¢çš„å·¥ä½œæ˜¯è®¡ç®—æè¿°ç¬¦çš„å®‰è£…åœ°å€ï¼šå…ˆå¾—åˆ°æè¿°ç¬¦è¡¨çš„ç•Œé™å€¼ï¼Œå°†å®ƒåŠ  1ï¼Œå¾—åˆ°æè¿°ç¬¦è¡¨çš„æ€»å­—èŠ‚æ•°ï¼Œè¿™å®é™…ä¸Šä¹Ÿæ˜¯æ–°æè¿°ç¬¦åœ¨ GDT å†…çš„åç§»é‡ã€‚
       ;ç„¶åç”¨ GDT çš„çº¿æ€§åœ°å€åŠ ä¸Šè¿™ä¸ªåç§»é‡ï¼Œå°±æ˜¯ç”¨äºå®‰è£…æ–°æè¿°ç¬¦çš„çº¿æ€§åœ°å€ã€‚

       ;GDT ç•Œé™
       ;movzx ç”¨äºå°†ä¸€ä¸ªè¾ƒå°çš„æ•°æ®å€¼é›¶æ‰©å±•åˆ°æ›´å¤§çš„å¯„å­˜å™¨ä¸­ã€‚å…¶å«ä¹‰æ˜¯ "Move with Zero-Extend"ï¼Œå³å°†æºæ“ä½œæ•°åŠ è½½åˆ°ç›®æ ‡å¯„å­˜å™¨æ—¶ï¼Œç”¨ 0 å¡«å……é«˜ä½ã€‚
       movzx ebx,word [pgdt]
       ;GDT æ€»å­—èŠ‚æ•°ï¼Œä¹Ÿæ˜¯ä¸‹ä¸€ä¸ªæè¿°ç¬¦åç§» 
       inc bx
       ;ä¸‹ä¸€ä¸ªæè¿°ç¬¦çš„çº¿æ€§åœ°å€
       add ebx,[pgdt+2]

       mov [es:ebx],eax
       mov [es:ebx+4],edx

       ;å¢åŠ ä¸€ä¸ªæè¿°ç¬¦çš„å¤§å°
       ;åœ¨æœºå™¨åˆšåŠ ç”µæˆ–å¤„ç†å™¨å¤ä½åï¼ŒGDT çš„åŸºåœ°å€è¢«é»˜è®¤åœ°è®¾ç½®ä¸º 0ï¼Œè€Œç•Œé™å€¼è¢«è®¾ç½®æˆ 0xFFFF
       add word [pgdt],8                     
       ;å¯¹ GDT çš„æ›´æ”¹ç”Ÿæ•ˆ
       lgdt [pgdt]                         
       ;å¾—åˆ° GDT æœ€æ–°çš„ç•Œé™å€¼
       mov ax,[pgdt]                      
       xor dx,dx
       mov bx,8
       ;é™¤ä»¥ 8ï¼Œå»æ‰ä½™æ•°ï¼Œæ­¤æ—¶å•† ax å°±æ˜¯æ–°å®‰è£…çš„æ®µæè¿°ç¬¦çš„ç´¢å¼•å·
       div bx                             
       mov cx,ax
       ;å°†ç´¢å¼•å·ç§»åˆ°æ­£ç¡®ä½ç½®ï¼Œæ­¤æ—¶ RPL=0ï¼ŒTI=0ï¼ˆè¡¨ç¤ºåœ¨ GDT ä¸­ï¼‰
       shl cx,3

       pop es
       pop ds

       pop edx
       pop ebx
       pop eax

       retf 

;æ„é€ å­˜å‚¨å™¨å’Œç³»ç»Ÿçš„æ®µæè¿°ç¬¦
;è¾“å…¥ï¼šeax=çº¿æ€§åŸºåœ°å€
;      ebx=æ®µç•Œé™
;      ecx=å±æ€§ï¼Œå„å±æ€§ä½éƒ½åœ¨åŸå§‹ä½ç½®ï¼Œæ— å…³çš„ä½æ¸…é›¶ 
;è¿”å›ï¼šedx:eax=æè¿°ç¬¦
make_seg_descriptor:    

       mov edx,eax
       shl eax,16
       ;æè¿°ç¬¦å‰ 32 ä½ eax æ„é€ å®Œæ¯•
       or ax,bx                           

       ;æ¸…é™¤åŸºåœ°å€ä¸­æ— å…³çš„ä½
       and edx,0xffff0000                 
       rol edx,8
       ;è£…é…åŸºå€çš„ 31~24 å’Œ 23~16 (80486+)
       bswap edx                          

       xor bx,bx
       ;è£…é…æ®µç•Œé™çš„é«˜ 4 ä½
       or edx,ebx                         
       ;è£…é…å±æ€§
       or edx,ecx                         

       retf

;========================ğŸ•å†…æ ¸æ•°æ®æ®µğŸ•======================================

SECTION core_data vstart=0                

       ;ç”¨äºè®¾ç½®å’Œä¿®æ”¹ GDT
       ;è¿™é‡Œçš„ä½ 2 å­—èŠ‚ä¿å­˜ GDT çš„ç•Œé™ï¼Œè€Œé«˜ 4 å­—èŠ‚ä¿å­˜ GDT çš„ 32 ä½ç‰©ç†åœ°å€
       pgdt             dw  0
                        dd  0

       ;ä¸‹æ¬¡åˆ†é…å†…å­˜æ—¶çš„èµ·å§‹åœ°å€
       ram_alloc        dd  0x00100000    

       ;ç¬¦å·åœ°å€æ£€ç´¢è¡¨
       salt:
       salt_1           db  '@PrintString'
                        times 256-($-salt_1) db 0
                        dd  put_string
                        dw  sys_routine_seg_sel

       salt_2           db  '@ReadDiskData'
                        times 256-($-salt_2) db 0
                        dd  read_hard_disk_0
                        dw  sys_routine_seg_sel

       salt_3           db  '@PrintDwordAsHexString'
                        times 256-($-salt_3) db 0
                        dd  put_hex_dword
                        dw  sys_routine_seg_sel

       salt_4           db  '@TerminateProgram'
                        times 256-($-salt_4) db 0
                        dd  return_point
                        dw  core_code_seg_sel

       salt_item_len    equ $-salt_4
       salt_items       equ ($-salt)/salt_item_len

       message_1        db  '  If you seen this message,that means we '
                        db  'are now in protect mode,and the system '
                        db  'core is loaded,and the video display '
                        db  'routine works perfectly.',0x0d,0x0a,0

       message_5        db  '  Loading user program...',0
       
       do_status        db  'Done.',0x0d,0x0a,0
       
       message_6        db  0x0d,0x0a,0x0d,0x0a,0x0d,0x0a
                        db  '  User program terminated,control returned.',0

       bin_hex          db '0123456789ABCDEF'
       ;put_hex_dwordå­è¿‡ç¨‹ç”¨çš„æŸ¥æ‰¾è¡¨
       ;å†…æ ¸ç”¨çš„ç¼“å†²åŒº 
       core_buf         times 2048 db 0         
       ;å†…æ ¸ç”¨æ¥ä¸´æ—¶ä¿å­˜è‡ªå·±çš„æ ˆæŒ‡é’ˆ
       esp_pointer      dd 0                   
       cpu_brnd0        db 0x0d,0x0a,'  ',0
       cpu_brand        times 52 db 0
       cpu_brnd1        db 0x0d,0x0a,0x0d,0x0a,0


;========================ğŸ‰å†…æ ¸ä»£ç æ®µğŸ‰======================================
SECTION core_code vstart=0

;åŠ è½½å¹¶é‡å®šä½ç”¨æˆ·ç¨‹åº
;è¾“å…¥ï¼šESI=èµ·å§‹é€»è¾‘æ‰‡åŒºå·
;è¿”å›ï¼šAX=æŒ‡å‘ç”¨æˆ·ç¨‹åºå¤´éƒ¨çš„é€‰æ‹©å­ 
load_relocate_program:

       push ebx
       push ecx
       push edx
       push esi
       push edi

       push ds
       push es

       ;å°†å†…æ ¸çš„æ•°æ®æ®µé€‰æ‹©å­ä¿å­˜åˆ° ds å¯„å­˜å™¨ä¸­
       mov eax,core_data_seg_sel
       ;åˆ‡æ¢ ds åˆ°å†…æ ¸æ•°æ®æ®µ
       mov ds,eax

       ;è¯»å–ç¨‹åºå¤´éƒ¨æ•°æ®
       mov eax,esi    
       ;core_buf æ˜¯åœ¨å†…æ ¸æ•°æ®æ®µä¸­å®šä¹‰çš„ç¼“å†²åŒºï¼Œå¤§å°ä¸º 2048 ä¸ªå­—èŠ‚
       mov ebx,core_buf
       ;ä» eax å¼€å§‹çš„é€»è¾‘æ‰‡åŒºå·è¯»å–ä¸€ä¸ªæ‰‡åŒºçš„æ•°æ®åˆ° ds:ebx å¤„çš„å†…å­˜ç¼“å†²åŒºåŒºåŸŸ
       ;è¿™æ ·å¯ä»¥æŠŠç”¨æˆ·ç¨‹åºå¤´éƒ¨æ•°æ®è¯»å–åˆ°å‰é¢å†…æ ¸å®šä¹‰çš„ç¼“å†²åŒºä¸­
       call sys_routine_seg_sel:read_hard_disk_0

       ;ä»¥ä¸‹åˆ¤æ–­æ•´ä¸ªç¨‹åºæœ‰å¤šå¤§
       ;é¦–å…ˆè·å–ç”¨æˆ·ç¨‹åºæ•´ä½“å°ºå¯¸
       mov eax,[core_buf]
       mov ebx,eax
       ;æ‰€æœ‰èƒ½è¢« 512 æ•´é™¤çš„æ•°ï¼Œæœ€ä½ç«¯çš„ 9 ä¸ªæ¯”ç‰¹éƒ½ä¸º 0
       ;and æŒ‡ä»¤ä½¿ç¨‹åºå°ºå¯¸ 512 å­—èŠ‚å¯¹é½ï¼ˆèƒ½å¤Ÿè¢« 512 æ•´é™¤ï¼‰ 
       and ebx,0xfffffe00  
       ;å¦‚æœç”¨æˆ·ç¨‹åºå¤§å°ä¸ä¸º 512 çš„æ•´æ•°å€ï¼Œé‚£ä¹ˆä¸‹é¢æŒ‡ä»¤ä¼šå¯¹ç¨‹åºå¤§å°å‡‘æ•´ï¼Œæ­£å¥½ä¸ºç”¨æˆ·ç¨‹åºæ‰€å ç”¨çš„æ‰‡åŒºæ•°
       ;å¦‚æœç”¨æˆ·ç¨‹åºå¤§å°ä¸º 512 çš„æ•´æ•°å€ï¼Œé‚£ä¹ˆä¸‹é¢æŒ‡ä»¤ä¼šå°†ç”¨æˆ·ç¨‹åºå ç”¨çš„æ‰‡åŒºæ•°å¤šå¢åŠ  1      
       add ebx,512
       ;test æŒ‡ä»¤æ˜¯ä¸€æ¡é€»è¾‘æŒ‡ä»¤ï¼Œç”¨äºæ‰§è¡ŒæŒ‰ä½ä¸æ“ä½œï¼Œå¹¶æ ¹æ®ç»“æœæ›´æ–°å¤„ç†å™¨çš„çŠ¶æ€æ ‡å¿—ï¼Œtest æŒ‡ä»¤ä¸æ”¹å˜ä»»ä½•æ“ä½œæ•°çš„å€¼
       ;ç¨‹åºçš„å¤§å°æ­£å¥½æ˜¯ 512 çš„å€æ•°å—?
       test eax,0x000001ff                
       ;ä¸æ˜¯ï¼Œå°±ä½¿ç”¨å‡‘æ•´çš„ç»“æœ ebx
       ;æ˜¯ï¼Œå°±ä½¿ç”¨åŸæ¥ç¨‹åºçš„å¤§å° eax
       cmovnz eax,ebx

       ;å®é™…éœ€è¦ç”³è¯·çš„å†…å­˜å­—èŠ‚å¤§å°ï¼ˆå‰é¢è®¡ç®—çš„ç¨‹åºå ç”¨çš„æ‰‡åŒºæ•° * 512ï¼‰
       mov ecx,eax
       call sys_routine_seg_sel:allocate_memory
       ;ebx -> ç”³è¯·åˆ°çš„å†…å­˜é¦–åœ°å€
       mov ebx,ecx
       ;ä¿å­˜ä¸ºè¯¥å†…å­˜æ®µåˆ†é…çš„èµ·å§‹åœ°å€
       push ebx
       xor edx,edx
       mov ecx,512
       ;32 ä½çš„ div æŒ‡ä»¤ä¼šå¯¹ 64 ä½çš„è¢«é™¤æ•° edx:eax è¿›è¡Œé™¤æ³•è¿ç®—ï¼Œå•†å­˜å‚¨åœ¨ eaxï¼Œä½™æ•°å­˜å‚¨åœ¨ edx
       div ecx
       ;æ€»æ‰‡åŒºæ•°
       mov ecx,eax                         

       ;åˆ‡æ¢ ds åˆ° 0-4GB çš„æ•°æ®æ®µ
       mov eax,mem_0_4_gb_seg_sel         
       mov ds,eax

       ;èµ·å§‹æ‰‡åŒºå·
       mov eax,esi                         
  .b1: 
       ;ä» eax æŒ‡å®šçš„é€»è¾‘æ‰‡åŒºå·è¯»å–ä¸€ä¸ªæ‰‡åŒºæ•°æ®åˆ°å†…å­˜ ds:ebx çš„åŒºåŸŸ
       ;ebx å°±æ˜¯ allocate_memory å‡½æ•°è¿”å›çš„å†…å­˜èµ·å§‹åœ°å€
       call sys_routine_seg_sel:read_hard_disk_0
       inc eax
       ;å¾ªç¯è¯»ï¼Œç›´åˆ°è¯»å®Œæ•´ä¸ªç”¨æˆ·ç¨‹åº
       loop .b1                           

       ;å»ºç«‹ç”¨æˆ·ç¨‹åºå¤´éƒ¨æ®µæè¿°ç¬¦
       ;å‰é¢å°†ç”³è¯·åˆ°çš„ç”¨æˆ·ç¨‹åºåœ¨å†…å­˜é¦–åœ°å€ ebx å‹å…¥æ ˆï¼Œç°åœ¨å°†ç”¨æˆ·ç¨‹åºå¤´éƒ¨èµ·å§‹çº¿æ€§åœ°å€å¼¹å‡ºåˆ° edi å¯„å­˜å™¨ä¸­
       pop edi
       mov eax,edi
       ;è·å–ç”¨æˆ·ç¨‹åºå¤´éƒ¨æ®µé•¿åº¦
       mov ebx,[edi+0x04]
       ;è·å–ç”¨æˆ·ç¨‹åºå¤´éƒ¨æ®µçš„æ®µç•Œé™
       dec ebx
       mov ecx,0x00409200
       ;ç”Ÿæˆå­—èŠ‚ç²’åº¦çš„æ•°æ®æ®µæè¿°ç¬¦
       call sys_routine_seg_sel:make_seg_descriptor
       ;å°†ç”Ÿæˆçš„ç”¨æˆ·ç¨‹åºå¤´éƒ¨æ®µæè¿°ç¬¦å®‰è£…åˆ° GDT ä¸­
       call sys_routine_seg_sel:set_up_gdt_descriptor
       ;å°†æ­¤æè¿°ç¬¦é€‰æ‹©å­ä¿å­˜åˆ°ç”¨æˆ·ç¨‹åºå¤´éƒ¨ 0x04 åç§»å¤„
       mov [edi+0x04],cx

       ;å»ºç«‹ç”¨æˆ·ç¨‹åºä»£ç æ®µæè¿°ç¬¦
       mov eax,edi
       ;ä»£ç èµ·å§‹çº¿æ€§åœ°å€
       add eax,[edi+0x14]
       ;ä»£ç æ®µé•¿åº¦
       mov ebx,[edi+0x18]
       ;ä»£ç æ®µç•Œé™
       dec ebx                            
       mov ecx,0x00409800
       ;eax=çº¿æ€§åŸºåœ°å€ï¼Œebx=æ®µç•Œé™ï¼Œecx=å±æ€§
       call sys_routine_seg_sel:make_seg_descriptor
       call sys_routine_seg_sel:set_up_gdt_descriptor
       ;å°†ç”¨æˆ·ç¨‹åºä»£ç æ®µæè¿°ç¬¦çš„é€‰æ‹©å­ä¿å­˜åˆ°ç”¨æˆ·ç¨‹åºå¤´éƒ¨ 0x14 åç§»å¤„
       mov [edi+0x14],cx

       ;å»ºç«‹ç”¨æˆ·ç¨‹åºæ•°æ®æ®µæè¿°ç¬¦
       mov eax,edi
       ;æ•°æ®æ®µèµ·å§‹çº¿æ€§åœ°å€
       add eax,[edi+0x1c]
       ;æ®µé•¿åº¦
       mov ebx,[edi+0x20]
       ;æ®µç•Œé™
       dec ebx                            
       ;å­—èŠ‚ç²’åº¦çš„æ•°æ®æ®µæè¿°ç¬¦
       mov ecx,0x00409200
       call sys_routine_seg_sel:make_seg_descriptor
       call sys_routine_seg_sel:set_up_gdt_descriptor
       ;å°†ç”¨æˆ·ç¨‹åºæ•°æ®æ®µæè¿°ç¬¦é€‰æ‹©å­ä¿å­˜åˆ° 0x1c åç§»å¤„
       mov [edi+0x1c],cx

       ;å»ºç«‹ç¨‹åºå †æ ˆæ®µæè¿°ç¬¦
       ;4KB çš„å€ç‡ 
       mov ecx,[edi+0x0c]
       mov ebx,0x000fffff
       ;å¾—åˆ°æ®µç•Œé™
       sub ebx,ecx
       mov eax,4096
       ;ç”¨ eax å¯„å­˜å™¨ä¸­çš„å€¼ä¹˜ä»¥å¦å¤–ä¸€ä¸ª 32 ä½çš„æ•°ï¼Œåœ¨ edx:eax ä¸­å¾—åˆ° 64 ä½çš„ç»“æœ
       mul dword [edi+0x0c]
       ;å‡†å¤‡ä¸ºå †æ ˆåˆ†é…å†…å­˜
       mov ecx,eax
       call sys_routine_seg_sel:allocate_memory
       ;å¾—åˆ°å †æ ˆçš„é«˜ç«¯ç‰©ç†åœ°å€
       add eax,ecx
       ;4KB ç²’åº¦çš„å †æ ˆæ®µæè¿°ç¬¦
       mov ecx,0x00c09600
       call sys_routine_seg_sel:make_seg_descriptor
       call sys_routine_seg_sel:set_up_gdt_descriptor
       mov [edi+0x08],cx

       ;é‡å®šä½ SALT
       mov eax,[edi+0x04]
       ;es ä¸ºç”¨æˆ·ç¨‹åºå¤´éƒ¨æ®µçš„æè¿°ç¬¦é€‰æ‹©å­
       mov es,eax
       ;ds ä¸ºå†…æ ¸ç¨‹åºæ•°æ®æ®µçš„æè¿°ç¬¦é€‰æ‹©å­
       mov eax,core_data_seg_sel
       mov ds,eax

       ;cld å°† EFLAGS å¯„å­˜å™¨ä¸­çš„æ–¹å‘æ ‡å¿— DF æ¸…é›¶ï¼Œåœ°å€æŒ‰é€’å¢çš„æ–¹å‘è¿›è¡Œæ¯”è¾ƒ
       cld

       ;ç”¨æˆ·ç¨‹åºçš„ U-SALT æ¡ç›®æ•°ï¼Œä¹Ÿæ˜¯å¤–å¾ªç¯çš„å¾ªç¯æ¬¡æ•°
       mov ecx,[es:0x24]
       ;ç”¨æˆ·ç¨‹åºå†…çš„ U-SALT ä½äºå¤´éƒ¨å†… 0x28 å¤„ï¼Œes:edi æŒ‡å‘ç”¨æˆ·ç¨‹åº U-SALT è¡¨æ¡ç›®
       mov edi,0x28
  .b2:
       push ecx
       push edi

       ;å†…æ ¸ç¨‹åºä¸­ C-SALT æ¡ç›®çš„æ•°é‡ï¼Œä¹Ÿæ˜¯å†…å¾ªç¯çš„å¾ªç¯æ¬¡æ•°
       mov ecx,salt_items
       ;ds:esi æŒ‡å‘å†…æ ¸ç¨‹åºçš„ C-SALT æ¡ç›®
       ;es:edi æŒ‡å‘ç”¨æˆ·ç¨‹åºçš„ U-SALT æ¡ç›®
       mov esi,salt
  .b3:
       push edi
       push esi
       push ecx

       ;æ£€ç´¢è¡¨ä¸­ï¼Œæ¯æ¡ç›®çš„æ¯”è¾ƒæ¬¡æ•°
       mov ecx,64
       ;æ¯æ¬¡æ¯”è¾ƒ 4 å­—èŠ‚ï¼Œrepe è‹¥ç›¸ç­‰åˆ™é‡å¤
       repe cmpsd
       jnz .b4
       ;è‹¥åŒ¹é…ï¼Œesi æ°å¥½æŒ‡å‘å†…æ ¸ç¨‹åºä¸­ç¬¦å·ååçš„åç§»åœ°å€
       mov eax,[esi]                      
       ;å¯¹ç”¨æˆ·ç¨‹åºçš„ salt è¡¨æ¡ç›®ä¾æ¬¡å†™å…¥ 4 å­—èŠ‚çš„åç§»åœ°å€å’Œ 2 å­—èŠ‚çš„æ®µé€‰æ‹©å­ 
       mov [es:edi-256],eax
       mov ax,[esi+4]
       mov [es:edi-252],ax
  .b4:
       pop ecx
       pop esi
       ;esi åŠ ä¸Š salt_item_lenï¼ŒæŒ‡å‘å†…æ ¸ salt è¡¨ä¸­ä¸‹ä¸€ä¸ªæ¡ç›®
       add esi,salt_item_len
       ;ä»å¤´æ¯”è¾ƒ
       pop edi
       loop .b3

       pop edi
       ;edi åŠ ä¸Š 256ï¼ŒæŒ‡å‘ç”¨æˆ·ç¨‹åº salt è¡¨ä¸­ä¸‹ä¸€ä¸ªæ¡ç›®
       add edi,256
       pop ecx
       loop .b2

       ;å°†ç”¨æˆ·ç¨‹åºå¤´éƒ¨çš„é€‰æ‹©å­ä¿å­˜åˆ° ax å¯„å­˜å™¨ä¸­
       mov ax,[es:0x04]
       ;æ¢å¤åˆ°è°ƒç”¨æ­¤è¿‡ç¨‹å‰çš„ es æ®µ
       pop es                             
       ;æ¢å¤åˆ°è°ƒç”¨æ­¤è¿‡ç¨‹å‰çš„ ds æ®µ
       pop ds                             

       pop edi
       pop esi
       pop edx
       pop ecx
       pop ebx

       ret
      
start:
       ;ä½¿ ds æŒ‡å‘æ ¸å¿ƒæ•°æ®æ®µ
       mov ecx,core_data_seg_sel
       mov ds,ecx

       ;è°ƒç”¨ put_string ä¾‹ç¨‹æ¥åœ¨å±å¹•ä¸Šæ˜¾ç¤ºå­—ç¬¦ä¸² message_1 ä¿¡æ¯
       mov ebx,message_1
       ;è°ƒç”¨ put_string ä¾‹ç¨‹æ˜¾ç¤º 0 ç»ˆæ­¢çš„å­—ç¬¦ä¸²å¹¶ç§»åŠ¨å…‰æ ‡ï¼Œè¾“å…¥å­—ç¬¦ä¸²åœ°å€ç”± DS:EBX ç»™å‡º
       call sys_routine_seg_sel:put_string
                                   
       ;æ˜¾ç¤ºå¤„ç†å™¨å“ç‰Œä¿¡æ¯ 
       mov eax,0x80000002
       cpuid
       mov [cpu_brand + 0x00],eax
       mov [cpu_brand + 0x04],ebx
       mov [cpu_brand + 0x08],ecx
       mov [cpu_brand + 0x0c],edx

       mov eax,0x80000003
       cpuid
       mov [cpu_brand + 0x10],eax
       mov [cpu_brand + 0x14],ebx
       mov [cpu_brand + 0x18],ecx
       mov [cpu_brand + 0x1c],edx

       mov eax,0x80000004
       cpuid
       mov [cpu_brand + 0x20],eax
       mov [cpu_brand + 0x24],ebx
       mov [cpu_brand + 0x28],ecx
       mov [cpu_brand + 0x2c],edx

       ;ä»å¤„ç†å™¨è¿”å›çš„æ•°æ®éƒ½æ˜¯ç°æˆçš„ ASCII ç ï¼Œå…ˆåœ¨å±å¹•ä¸Šç•™å‡ºç©ºè¡Œå†æ˜¾ç¤ºå¤„ç†å™¨å“ç‰Œä¿¡æ¯ï¼Œç„¶åå†ç•™ç©ºï¼Œä»¥çªå‡ºè¦æ˜¾ç¤ºçš„å†…å®¹
       mov ebx,cpu_brnd0
       call sys_routine_seg_sel:put_string
       mov ebx,cpu_brand
       call sys_routine_seg_sel:put_string
       mov ebx,cpu_brnd1
       call sys_routine_seg_sel:put_string

       ;æ˜¾ç¤ºä¿¡æ¯ï¼Œè¦å¼€å§‹åŠ è½½ç”¨æˆ·ç¨‹åº
       mov ebx,message_5
       call sys_routine_seg_sel:put_string
       ;ç”¨æˆ·ç¨‹åºä½äºé€»è¾‘ 50 æ‰‡åŒº
       mov esi,50                           
       call load_relocate_program

       mov ebx,do_status
       call sys_routine_seg_sel:put_string
       ;ä¸´æ—¶ä¿å­˜å †æ ˆæŒ‡é’ˆ
       mov [esp_pointer],esp               
       ;åœ¨ ds æ®µå¯„å­˜å™¨ä¸­ä¿å­˜ç”¨æˆ·ç¨‹åºå¤´éƒ¨æ®µæè¿°å­
       mov ds,ax
       ;æ§åˆ¶æƒäº¤ç»™ç”¨æˆ·ç¨‹åºï¼ˆå…¥å£ç‚¹ï¼‰
       ;å †æ ˆå¯èƒ½åˆ‡æ¢
       jmp far [0x10]                      
                                            

return_point:              
       ;ç”¨æˆ·ç¨‹åºè¿”å›ç‚¹                  
       ;ä½¿ ds æŒ‡å‘æ ¸å¿ƒæ•°æ®æ®µ
       mov eax,core_data_seg_sel           
       mov ds,eax
       ;åˆ‡æ¢å›å†…æ ¸è‡ªå·±çš„å †æ ˆ
       mov eax,core_stack_seg_sel          
       mov ss,eax 
       mov esp,[esp_pointer]

       mov ebx,message_6
       call sys_routine_seg_sel:put_string

       ;è¿™é‡Œå¯ä»¥æ”¾ç½®æ¸…é™¤ç”¨æˆ·ç¨‹åºå„ç§æè¿°ç¬¦çš„æŒ‡ä»¤
       ;ä¹Ÿå¯ä»¥åŠ è½½å¹¶å¯åŠ¨å…¶å®ƒç¨‹åº
       hlt
            
SECTION core_trail

core_end:
```

## ä¸‰ã€ç”¨æˆ·ç¨‹åºä»£ç 

ç”¨æˆ·ç¨‹åºå°†ç£ç›˜ä¸­çš„æ–‡ä»¶è¯»å–å¹¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œæœ€åè°ƒç”¨ TerminateProgram ä¾‹ç¨‹è¿”å›å†…æ ¸ç¨‹åºã€‚

```armasm{.line-numbers}
       ;ä»£ç æ¸…å•13-3
       ;æ–‡ä»¶åï¼šc13.asm
       ;æ–‡ä»¶è¯´æ˜ï¼šç”¨æˆ·ç¨‹åº 
       ;åˆ›å»ºæ—¥æœŸï¼š2011-10-30 15:19   
         
SECTION header vstart=0

       ;ç¨‹åºæ€»é•¿åº¦ #0x00
       program_length   dd program_end
       ;ç¨‹åºå¤´éƒ¨çš„é•¿åº¦ #0x04ï¼Œä¿å­˜ç”¨æˆ·ç¨‹åºå¤´éƒ¨æ®µæè¿°å­
       head_len         dd header_end
       ;ç”¨äºæ¥æ”¶å †æ ˆæ®µé€‰æ‹©å­ #0x08ï¼Œä¿å­˜å †æ ˆæ®µæè¿°å­
       stack_seg        dd 0
       ;ç”¨æˆ·ç¨‹åºå»ºè®®çš„å †æ ˆå¤§å°ï¼ˆä»¥ 4KB ä½å•ä½ï¼‰#0x0c
       stack_len        dd 1
                                  
       ;ç¨‹åºå…¥å£åœ°å€ #0x10           
       prgentry         dd start                
       ;ä»£ç æ®µä½ç½® #0x14
       ;å½“å†…æ ¸å®Œæˆç”¨æˆ·ç¨‹åºçš„åŠ è½½å’Œé‡å®šä½åï¼Œä¼šæŠŠè¯¥ä»£ç æ®µçš„æ®µé€‰æ‹©å­å›å¡«åˆ°è¿™é‡Œï¼ˆä»…å ç”¨æœ€ä½ 16 ä½ï¼‰
       code_seg         dd section.code.start   
       ;ä»£ç æ®µé•¿åº¦ #0x18
       code_len         dd code_end

       ;æ•°æ®æ®µä½ç½® #0x1cï¼Œä¿å­˜æ•°æ®æ®µæè¿°å­
       data_seg         dd section.data.start   
       ;æ•°æ®æ®µé•¿åº¦ #0x20
       data_len         dd data_end             
       
       ;ç¬¦å·åœ°å€æ£€ç´¢è¡¨çš„æ¡ç›®æ•° #0x24
       salt_items       dd (header_end-salt)/256 
       
       ;#0x28
       ;ç”¨æˆ·ç¨‹åºåœ¨åç§»åœ°å€ 0x28 å¤„æ„é€ ä¸€ä¸ªè¡¨æ ¼ï¼Œå¡«å†™ç”¨æˆ·ç¨‹åºéœ€è¦ç”¨åˆ°çš„ç¬¦å·å
       ;å†…æ ¸åœ¨åŠ è½½ç”¨æˆ·ç¨‹åºæ—¶ï¼Œä¼šå°†ç¬¦å·åç§°æ›¿æ¢ä¸ºç›¸åº”çš„å†…å­˜åœ°å€ï¼Œè¿™å°±æ˜¯è¿‡ç¨‹çš„é‡å®šä½
       salt:
       PrintString      db  '@PrintString'
                        times 256-($-PrintString) db 0
       TerminateProgram db  '@TerminateProgram'
                        times 256-($-TerminateProgram) db 0
       ReadDiskData     db  '@ReadDiskData'
                        times 256-($-ReadDiskData) db 0
                 
       header_end:

SECTION data vstart=0    
                         
       buffer            times 1024 db  0         

       message_1         db  0x0d,0x0a,0x0d,0x0a
                         db  '**********User program is runing**********'
                         db  0x0d,0x0a,0
       message_2         db  '  Disk data:',0x0d,0x0a,0

data_end:

      [bits 32]

SECTION code vstart=0
start:
       ;åœ¨å†…æ ¸ç¨‹åºè·³è½¬åˆ°ç”¨æˆ·ç¨‹åºä¹‹å‰ï¼Œå°±å°†ç”¨æˆ·ç¨‹åºå¤´éƒ¨æ®µçš„é€‰æ‹©å­ä¿å­˜åˆ° ds å¯„å­˜å™¨ä¸­
       mov eax,ds
       mov fs,eax

       ;åˆ‡æ¢åˆ°ç”¨æˆ·ç¨‹åºè‡ªå·±çš„æ ˆ
       mov eax,[stack_seg]
       mov ss,eax
       mov esp,0
       ;åˆ‡æ¢åˆ°ç”¨æˆ·ç¨‹åºè‡ªå·±çš„æ•°æ®æ®µï¼Œç°åœ¨ ds ä¿å­˜çš„æ˜¯ç”¨æˆ·æ•°æ®æ®µè€Œä¸æ˜¯å¤´éƒ¨æ®µçš„é€‰æ‹©å­
       mov eax,[data_seg]
       mov ds,eax

       mov ebx,message_1
       ;è°ƒç”¨å†…æ ¸ä¸­çš„ PrintString æ–¹æ³•ï¼Œæ˜¾ç¤º message_1 å­—ç¬¦ä¸²
       ;è¿™é‡Œè°ƒç”¨åˆ†ä¸¤æ­¥æ‰§è¡Œï¼Œç¬¬ 1 æ­¥å°±æ˜¯æ ¹æ® fs:PrintString æ‰¾åˆ°ç”¨æˆ·ç¨‹åºå¤´éƒ¨æ®µä¸­ PrintString æ ‡å·å¤„
       ;ç¬¬ 2 æ­¥å°±æ˜¯æ ¹æ® PrintString æ ‡å·å¤„çš„å†…æ ¸è°ƒç”¨ä¾‹ç¨‹æ®µé€‰æ‹©å­å’Œåç§»åœ°å€ï¼Œæ‰§è¡Œ 32 ä½é—´æ¥ç»å¯¹è¿œè°ƒç”¨ï¼Œè·³è½¬åˆ°å†…æ ¸çš„æ‰“å°ä¾‹ç¨‹æ‰§è¡Œ
       call far [fs:PrintString]
       ;è¯»å–ç¡¬ç›˜é€»è¾‘æ‰‡åŒºå· 100 ä¸­çš„æ•°æ®åˆ°ç¼“å†²åŒºä¸­
       mov eax,100
       ;ç¼“å†²åŒº buffer åç§»åœ°å€
       mov ebx,buffer
       ;æ‰§è¡Œå†…æ ¸çš„ read_hard_disk_0 ä¾‹ç¨‹ï¼Œä» eax ç£ç›˜å·è¯»å–æ•°æ®åˆ° buffer ç¼“å†²åŒº
       call far [fs:ReadDiskData]

       mov ebx,message_2
       call far [fs:PrintString]

       mov ebx,buffer
       call far [fs:PrintString]
       ;å°†æ§åˆ¶æƒè¿”å›åˆ°ç³»ç»Ÿ
       jmp far [fs:TerminateProgram]

code_end:

SECTION trail
program_end:
```