# OSPF 路由协议之区域结构设计

OSPF 把整个路由域划分为多个区域以减少区域泛洪的影响，继而减少 LSDB 的大小及计算开销。每个区域包含多台 OSPF 路由器，不同区域使用不同区域 ID 来标识。任何区域都使用区域 ID 标识，区域 ID 是 32 位数，例如：区域 0.0.0.0、区域 0.0.1.2、区域 3 等。区域 0 是骨干区域。

**OSPF 划分区域是以路由器为边界的，每条链路（网段）只能属于一个区域**。所以边界路由器上可能有多条链路分属于不同区域，运行 OSPF 的接口必须指明属于哪一个区域。

## 1.OSPF 区域结构设计

OSPF 定义区域类型为四种：骨干区域（Area0）、普通区域（Normal Area）、Stub 区域（包括 Totally Stub 区域）及 NSSA 区域（包括 Totally NSSA 区域）。

**骨干区域有且只有一个，所有其他区域必须同骨干区域相连，如果没有连接到骨干区域，将不会学到其他区域路由，OSPF 中所有区域间路由必须经骨干区域传递**。其他区域若没有连接到骨干区域，要使用 Vlink 连接到骨干区域。

骨干区域不能被分割，一旦分割，必须使用 Vlink 连接分割的骨干区域使之连续。也可以使用 GRE 隧道连接被分割的区域， OSPF 这种特殊的分层的设计结构用来避免区域间的路由所致的环路。

## 2.LSA3 及区域间路由通告

### 2.1 LSA3 的特性

<div align="center">
    <img src="ospf_static/68.png" width="500" height="280"/>
</div>

上图为区域间路由示意图，在 Area3 中，区域内的网络通过 LSA1 (StubNet 类型 Link) 和 LSA2 在区域内泛洪。ABR R1 产生 LSA3 向 Area0 通告 Area3 的路由，R2 和 R3 产生 LSA3，把各自学到的 Area0 里的区域间路由继续向区域 Area1 和 Area2 通告。

LSA3 的特性如下所示：

- 边界路由器 ABR 为区域内的每条 OSPF 路由各产生一份 LSA3 并向其他区域通告。
- 边界若有多个 ABR，则每个 ABR 都产生 LSA3 来通告区域间路由。R2 和 R3 是 Area0 和 Area2 的 ABR，两个 ABR 都产生 LSA3 通告路由进入 Area2，**所以在 Area2 中每条区域间路由在 LSDB 中都有两份 LSA3，分别由两个 ABR 产生。_这两份 LSA3 通过 `Adveritsing Router` 字域来区分_**。
- 区域间传递的是**路由**，LSA3 是由每个区域的 ABR 产生的，并仅在该区域内泛洪的一类 LSA。路由进入其他区域后，再由该区域的 ABR 产生 LSA3 继续泛洪。
- **OSPF 在区域边界上具备矢量特性，只有出现在 ABR 路由表里的路由才会被通告给邻居区域**。
- 计算路由时，路由器计算自己区域内到 ABR 的成本加上 LSA3 传递的区域间成本，得到的是当前路由器到目标网络端到端的成本。
- 如果 ABR 路由器上路由表中的某条 OSPF 路由不再可达，则 ABR 会立即产生一份 Age 为 3600s 的 LSA3 向区域内泛洪，用于在区域内撤销该网络。

### 2.2 区域间路由计算

OSPF 区域之间是通过 Type3 的 LSA 来交换路由信息的，这类 LSA 不携带拓扑信息，结构比较简单。Type3 LSA: Sum-net LSA，由 ABR 产生，在区域内泛洪，携带的信息是到其他区域的网络信息，不携带任何拓扑信息。

<div align="center">
    <img src="ospf_static/69.png"/>
</div>

其中，Ls id（Link State ID）为网络号，而 Adv rtr 表示产生 LSA3 的路由器，而 Net Mask 为子网掩码，Metric 为开销值（为 ABR 到 LSA3 中指示的目标网段的最小开销值）。下面我们以下图为例来对区域间路由进行分析。

<div align="center">
    <img src="ospf_static/70.png" width="380" height="250"/>
</div>

在上图中，R2 和 R3 在这个网络中属于 ABR，R1 会收到 R2 和 R3 产生的 LSA3，R2 上产生的 LSA3 开销值为 11，R3 上产生的 LSA3 开销值为 21。R1 做路由计算时，**把 ABR 产生的 LSA3 的路由当作节点 R2 和 R3 上的"叶子"路由**，所以 Area0 中 R1 计算去往 100.1.1.0/24 这个网段的路径是两条路径进行负载分担，下一跳分别是 R2 和 R3，路径开销是 31。

R1 计算其他区域的 LSA3 路由，是把 LSA3 路由直接挂在通告路由器 ABR 上，当成 ABR 节点上的叶子节点，所以区域间路由的任何变化，如成本变化或路由出现、消失都是 ABR 节点上所挂的叶子节点的变化，并没有影响到 Area0 内 SPF 树形拓扑的变化。仅叶子节点的变化所引起的计算称为 PRC（Partial Route Calculate），这种变化对网络的影响比较小。