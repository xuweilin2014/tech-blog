# iStack 和 CSS 配置和管理

## 零、istack 和 css 简介

交换机设备在网络中除了可以单独接入网络使用外，还可以通过部署堆叠或集群接入网络进行组合使用，在华为交换机中分别对应 iStack、CSS 功能。

华为交换机中的 iStack 功能就是通常所说的交换机堆叠功能，**<font color="red">在华为盒式系列交换机中支持，可把多台交换机配置成一台交换机来使用和管理，主要目的是解决单一交换机端口不足的问题，同时也可以提高单台交换机的可靠性</font>**。

<div align="center">
    <div align="center" style="color: #F14; font-size:13px; font-weight:bold">图 1 istack 堆叠</div>
    <img src="istack_css_static/1.png" width="450"/>
</div>

华为交换机中的 CSS 功能就是通常所说的交换机集群，**<font color="red">在华为框式系列交换机中支持，目前最多可把两台交换机配置成一台交换机来使用和管理，主要目的是解决单一交换机性能不足的问题，同时也可提高单台交换机的可靠性</font>**。

<div align="center">
    <div align="center" style="color: #F14; font-size:13px; font-weight:bold">图 2 css 集群</div>
    <img src="istack_css_static/2.png" width="450"/>
</div>

>盒式交换机：端口数量与类型在出厂时基本就定好了，后期通常不能像插卡那样继续扩展（要扩端口往往就是换更大型号或再加一台）。这种形态成本相对更友好、部署更简单，常见于园区网接入层/小型汇聚等场景；如果需要更高可用性，很多盒式机型会通过堆叠把多台逻辑上合成一台来管理与冗余。
>框式交换机：机框本身提供槽位，你按需插入线卡（端口模块）、主控/监督模块（Supervisor）、电源和风扇等部件，随着规模增长可以逐步加卡扩容。它的优势通常体现在更强的可扩展性与高可用设计，因此更常用于核心层或大型汇聚/数据中心等对性能与可靠性要求更高的场景。

使用堆叠、集群技术将独立的交换机虚拟化成一台逻辑的交换机，**一般接入、汇聚层盒式交换机采用堆叠技术，汇聚、核心层交换机采用集群技术**。在逻辑交换机之间使用链路聚合 eth-trunk 技术，无需部署 STP、VRRP 实现高可靠性。

<div align="center">
    <img src="istack_css_static/3.png" width="700"/>
</div>

## 一、istack 基础

### 1.istack 基础

交换机堆叠技术（Intelligent Stack）是将多台支持堆叠特性的交换机组合在一起，从逻辑上组合成一台整体交换机，这样不仅**可以通过一个命令行界面、一个 IP 地址对这些交换机进行集中管理**，还可以提高单台交换机的转发性能和可靠性，实现各成员交换机间的负载均衡。在如下图所示的拓扑结构中，左图中间的两台交换机通过堆叠就可看成右图中间的那一台交换机，这就是交换机堆叠的最直接、外在的表现形式。

<div align="center">
    <img src="istack_css_static/4.png" width="600"/>
</div>

istack 是华为 S 系列交换机的基本特性，无需获得 License 许可即可应用此功能。多台（最多 9 台）之间组成堆叠，相邻交换机间必须直接连接，中间不能有其他的交换机。istack 具有如下特性：

- 高可靠性：堆叠系统中的多台成员交换机之间可实现冗余备份，同时，istack 堆叠支持跨设备的链路聚合功能，故又可实现跨设备的链路冗余备份。
- 强大的网络扩展能力：通过增加成员交换机，**可以轻松地扩展堆叠系统的端口数、带宽和处理能力**。
- 简化设备配置和管理。一方面，**用户可以通过任何一台成员交换机登录堆叠系统，对堆叠系统所有成员交换机进行统一的配置和管理**；另一方面，堆叠形成后，不需要配置复杂的二层破环协议和三层保护倒换协议，简化了网络配置。

下面分别简单介绍一下 三层保护倒换协议和二层破环协议，**在没有堆叠的传统网络中，为了防止核心交换机坏掉导致全网断网，通常会放两台核心交换机（Switch A 和 Switch B）**。在终端侧（如电脑）通常只能配置一个默认网关地址，如果网关直接指向 Switch A 的三层接口，一旦 A 故障，终端就会失去网关而无法继续访问外网，填 Switch B 的 IP 地址也是同理，也就是正常情况下无法实现网关侧的冗余与主备切换。

因此在双网关场景中常用 VRRP 来实现三层网关冗余：**<font color="red">在 Switch A 与 Switch B 上为同一 VLAN/网段建立 VRRP 组，对外共同提供一个固定的虚拟网关（Virtual IP，通常还会对应一个虚拟 MAC），终端只需要把默认网关设置为该虚拟 IP 即可</font>**。VRRP 组内通过周期性发送 VRRP 通告报文来维持主备状态，正常情况下由优先级更高的设备担任 Master 负责对外转发，另一台作为 Backup 处于监听待命。当 Master 发生故障或链路异常导致通告报文消失时，Backup 在检测到超时后会提升为 Master，继承并接管该虚拟 IP（以及虚拟 MAC）继续对外提供网关转发能力，终端侧无需修改任何配置即可恢复通信。上述由主设备失效到备设备接管虚拟网关并恢复转发的过程，就是常说的三层保护倒换。

接下来说明二层破坏协议，二层破环是指当堆叠中的各成员交换机之间形成环形结构时消除二层环路，istack 有自己的破环机制，可以按以下计算公式快速找到用于消除二层环路的破环线：**<font color="red">从主设备堆叠端口 ID 较大的堆叠口开始数起，数 **`(n/2)+1`** 段链路后得到的这根网线就是破环线，它两端的端口都在阻塞状态</font>**。n 为堆叠环境中的设备数目，而且 **`(n/2)+1`** 取整数，不是四舍五入。

从 Master (switch1) 的较大堆叠口开始，假设 stack2 端口的堆叠 ID 大于 stack1 端口的堆叠 ID，所以从 switch1 的 stack2 接口出发数起。下图中有 4 台设备组成了环形堆叠，故 n=4，那么 **`(n/2)+1=3`**，也就是从主设备的 stack2 堆叠口开始数 3 段链路，第 3 段链路的网线（**`switch4/stack1 -> switch2/stack2`**）就是破环线。即 switch4 的 stack1 口和 switch2 的 stack2 口处于阻塞状态，因此 4 台交换机之间虽然物理上虽然连成了环，但逻辑上这条线断了，数据流向变成了马蹄形（链状），消除了二层环路。

<div align="center">
    <img src="istack_css_static/5.png" width="400"/>
</div>

### 2 istack 基本概念

**（1）交换机角色**

在 istack 堆叠中，所有的单台交换机都称为成员交换机，按照各自功能的不同又可以分为以下 3 种角色：

- 主交换机（Master）：负责整个堆叠系统的管理，一个堆叠只有一台主交换机；
- 备交换机（Standby）：是主交换机的备用交换机，用于当原主交换机出现故障时接替原主交换机的工作，管理整个堆叠系统。与主交换机一样，一个堆叠也只有一台备交换机；
- 从交换机（Slave）：**<font color="red">除了主交换机外的其他所有交换机（包括备交换机）都是从交换机。主要用于业务转发</font>**，从交换机的数量越多，堆叠系统的转发能力越强；

>注意，堆叠系统中的所有交换机都同时工作，并不是只有主交换机工作。

**（2）堆叠 ID**

堆叠 ID 为成员交换机在堆叠系统中的槽位号（Slot ID），用来标识和管理成员交换机，堆叠中所有成员交换机的堆叠 ID 都是唯一的。

华为智能堆叠（iStack）技术的核心逻辑，是将多台物理上独立的盒式交换机通过堆叠线缆互联，在控制平面和数据平面上虚拟化为一台逻辑交换机。系统通过堆叠 ID 这唯一的数字标识符来区分和定位堆叠系统中的每一台物理成员设备，从而实现对底层硬件资源的统一调度与管理。

在同一个堆叠域（Stack Domain）内，堆叠 ID 必须具有唯一性。**<font color="red">华为交换机的接口编号遵循 **`接口类型 堆叠 ID/子卡号/端口号`** 的三维格式，在单机运行模式下，由于设备/堆叠 ID 默认为 0，接口通常标识为 **`GigabitEthernet 0/0/1`**。一旦设备加入堆叠，其接口编号将强制与堆叠 ID 关联</font>**。

以两台华为 S5700 交换机组网为例，在独立状态下，两台设备的第一个千兆接口均显示为 **`GigabitEthernet 0/0/1`**。当构建堆叠系统并将第一台设备 ID 配置为 1，第二台设备 ID 配置为 2 后，接口索引将自动刷新，原第一台设备的接口变更为 **`GigabitEthernet 1/0/1`**，原第二台设备的接口则变更为 **`GigabitEthernet 2/0/1`**。

**（3）堆叠优先级**

堆叠优先级用于在堆叠角色选举过程中确定主交换机和备交换机的角色。**<font color="red">优先级值越大表示优先级越高，优先级越高当选为主交换机和备交换机的可能性越大</font>**。

### 3.堆叠链接方式

华为 S 系列交换机支持采用两种接口（专门的堆叠卡上的接口和普通业务接口）连接的方式来组建 istack 堆叠，故又分为两种堆叠连接方式：堆叠卡堆叠和业务口堆叠。

#### 3.1 堆叠卡堆叠

堆叠卡堆叠是各成员交换机间采用专用堆叠卡上的接口和专用堆叠线缆进行连接。

#### 3.2 业务口堆叠

业务口堆叠指的是交换机之间通过与逻辑堆叠端口绑定的普通业务端口连接，不需要采用专用的堆叠插卡连接。业务口堆叠涉及到如下两种端口的概念：

**（1）物理成员端口**

成员交换机之间用于堆叠连接的物理端口（就是交换机面板上那些普通的网口，比如万兆光口 XGE 等），是普通的业务端口，用于转发需要跨成员交换机的业务报文或成员交换机之间的堆叠协议报文。

**（2）逻辑堆叠端口**

逻辑堆叠端口是专用于堆叠的逻辑端口，但需要和前面介绍的物理成员端口进行绑定才能起作用，这是交换机操作系统内部虚拟出来的堆叠专用接口（逻辑堆叠端口是虚拟的，不能直接插网线），就像是一个容器。**<font color="red">堆叠的每台成员交换机上支持两个逻辑堆叠端口，分别为 **`stack-port n/1`** 和 **`stack-port n/2`**，其中 n 为成员交换机的堆叠 ID</font>**，以便实现成员交换机间的冗余链路连接，可提高堆叠连接的可靠性，但也可以仅通过一条链路连接。逻辑堆叠端口和物理成员端口之间的关系如下所示：

<div align="center">
    <img src="istack_css_static/6.png" width="450"/>
</div>

在业务口堆叠中，各成员交换机间通过物理成员端口的连接线缆又分为两种：普通线缆堆叠和专用线缆堆叠。

**（3）专用线缆堆叠**

专用堆叠线缆的两端区分主和备，**<font color="red">带有 Master 标签的一端为主端，不带有标签的一端为备端</font>**。使用专用线缆堆叠时，专用堆叠线缆按照规则插入物理成员端口后，交换机就可以自动组建堆叠，无需对逻辑堆叠端口进行额外的配置。

**（4）普通线缆堆叠**

在业务口堆叠中也可使用普通堆叠线缆连接，包括光线缆、双绞网线和高速电缆。使用普通线缆堆叠时，需要手动配置物理成员端口对应的逻辑堆叠端口，否则无法完成堆叠的组建（**<font color="red">因为交换机不知道用户想用哪根网线做堆叠</font>**，所以用户必须手动敲命令把物理口加入到逻辑堆叠口中。如果不配置，插上线没有任何反应，堆叠无法建立）。

假设我们有两台交换机，我们想用普通光纤进行业务口堆叠。设备 A 的堆叠 ID 配置为 1，设备 B 的堆叠 ID 配置为 2。我们想用两台机器的万兆口 (XGigabitEthernet) 第 51 号端口相连。

```java{.line-numbers}
// 第一步：在设备 A (ID 1) 上操作
// 我们需要把物理口 XGE 0/0/51 绑定到逻辑口 stack-port 1/1 中。
// 进入 ID 为 1 的交换机的第 1 个逻辑堆叠口
[SwitchA] interface stack-port 1/1      
// 这就完成了绑定。现在，插在51号口的网线传输的数据，会被送入 stack-port 1/1 进行处理。
[SwitchA-stack-port1/1] port interface XGigabitEthernet 0/0/51 enable
// 第二步：在设备 B (ID 2) 上操作
// 我们需要把物理口 XGE 0/0/51 绑定到逻辑口 stack-port 2/1 中。
// 进入 ID 为 2 的交换机的第 1 个逻辑堆叠口
[SwitchB] interface stack-port 2/1      
[SwitchB-stack-port2/1] port interface XGigabitEthernet 0/0/51 enable
```

### 4.堆叠的建立流程

要成功组建一个堆叠系统，需要按照以下流程进行：

- 物理连接：根据网络需求，按照上节的介绍选择适当的堆叠连接方式和连接拓扑，组建堆叠网络。
- 主交换机选举：在一个堆叠系统中只有一台交换机可成为主交换机。主交换机是通过选举确定的。
- 拓扑收集和备交换机选举：堆叠系统的主交换机确定后，**<font color="red">主交换机会收集所有成员交换机的拓扑信息，并向所有成员交换机分配堆叠 ID，之后选出堆叠系统的备交换机</font>**。
- 稳定运行：主交换机将整个堆叠系统的拓扑信息同步给所有成员交换机，成员交换机同步主交换机的系统软件和配置文件，之后进入稳定的运行状态。

#### 4.1 物理连接

每种连接方式都可组成链式连接以及环形连接这 2 种拓扑。

对于链式连接来说，优点是首尾不需要有物理连接，适合长距离堆叠，缺点就是可靠性低，其中一条堆叠链路出现故障，就会造成堆叠分裂。**<font color="red">链式连接适用于堆叠成员交换机距离较远时，组建环形连接比较困难，可以使用链形连接</font>**。

<div align="center">
    <div align="center" style="color: #F14; font-size:13px; font-weight:bold">链式连接</div>
    <img src="istack_css_static//7.png" width="350"/>
</div>

对于环形连接来说，优点是可靠性高，其中一条堆叠链路出现故障，环形拓扑变成链形拓扑，不影响堆叠系统正常工作。首尾需要有物理连接，不适合长距离堆叠。**<font color="red">适用场景为堆叠成员交换机距离较近时，建议使用环形连接</font>**。

<div align="center">
    <div align="center" style="color: #F14; font-size:13px; font-weight:bold">环形连接</div>
    <img src="istack_css_static//8.png" width="350"/>
</div>

#### 4.2 主交换机选举

确定好堆叠的连接方式和连接拓扑，完成成员交换机之间的物理连接之后，给所有成员交换机上电。此时堆叠系统开始进行主交换机的选举。主交换机的选举规则如下（依次从第一步开始判断，直至找到最优的交换机为止）：

1. **<font color="red">已经运行的交换机比处于启动状态的交换机优先竞争为主交换机。如果希望指定某一成员交换机为主交换机，则可以先为其上电</font>**，待其启动完成后再给其他成员交换机上电；

堆叠主交换机选举超时时间为 20s，堆叠成员交换机上电或重启时，由于不同成员交换机所需的启动时间可能差异比较大，因此不是所有成员交换机都有机会参与主交换机的第一次选举。后启动的交换机加入堆叠系统时，**<font color="red">最终的主交换机选举结果会因后启动的交换机在堆叠中所处位置的不同，以及先启动交换机间是否已成功组建一个统一的堆叠系统而有所不同</font>**。

比如有 **`A-B-C`** 连接方式的 3 台设备组建链形堆叠：

- 如果 A、B 先启动，C 后启动。此时 A、B 已组建成了一个堆叠系统，故 C 后面加入时，只能被动加入堆叠成为非主交换机。
- 如果 A、C 先启动。此时 A、C 各自成为自己堆叠系统的主交换机，没有形成统一的堆叠系统。在 B 启动加入堆叠系统时，A 和 C 会根据启动时间重新进行新的统一堆叠系统中的主交换机的竞争，竞争主交换机失败的交换机会重启，再以非主交换机加入堆叠。

2. 如果两台竞争主机交换机的成员交换机是同时启动的，此时再看哪台成员交换机的堆叠优先级高，堆叠优先高的交换机优先为主交换机。
3. 当有多台成员交换机同时启动，并且堆叠优先级也相同时，MAC 地址（设备的 MAC 地址）小的交换机优先竞争为主交换机。

#### 4.3 拓扑收集和备交换机选举

主交换机选举完成后，主交换机会收集所有成员交换机的拓扑信息，根据拓扑信息计算出堆叠转发表项和破环点（如果是环形堆叠结构时）信息，下发给堆叠中的所有成员交换机，并向所有成员交换机分配堆叠 ID。之后进行备交换机的选举。

**<font color="red">除主交换机外，最先完成设备启动的交换机优先被选为备份交换机</font>**。当除主交换机外其他交换机同时完成启动时，备交换机的选举规则如下（依次从第一步开始判断，直至找到最优的交换机为止）。

1. 堆叠优先级最高的设备成为备交换机；
2. 堆叠优先级相同时，MAC 地址最小的成为备交换机；

除主交换机和备交换机之外，剩下的其他成员交换机作为从交换机加入堆叠。

### 5.堆叠的登陆和访问

istack 堆叠建立好后，多台成员交换机就组成了一台虚拟设备存在于网络中，堆叠系统的接口编号规则以及登录与访问的方式都发生了变化。

堆叠系统的接口编号采用堆叠 ID 作为标识信息，所有成员交换机的堆叠 ID 都是唯一的。对 **<font color="red">于单台没有运行堆叠的设备，接口编号采用：`槽位号/子卡号/端口号`（支持 istack 堆叠功能的 S 系列交换机均为盒式设备，槽位号固定为 0）。设备加入堆叠后，接口编号采用：`堆叠 ID/子卡号/端口号`</font>**。

从以上可以看出，**设备加入堆叠前后，接口编号变化的只是其组成的第一部分，由原来的 0 变成了对应的堆叠 ID**。子卡号与端口号的编号规则与单机状态下一致。如果设备没有运行堆叠时，某个接口的编号为 **`GigabitEthernet0/0/1`**；当该设备加入堆叠后，如果堆叠 ID 为 2，则该接口的编号将变为 **`GigabitEthernet2/0/1`**。

如果设备曾加入过堆叠，在退出出堆叠后，仍然会使用组成堆叠时的堆叠 ID 作为自身的槽位号。但对于管理网口，无论系统是否运行堆叠以及运行堆叠后堆叠 ID 是多少，每台成员交换机的管理网口的编号均固定为 **`MEth 0/0/1`**，但此时并不是每台成员交换机的管理网口均可使用了。

>在华为以及几乎所有企业级交换机中，管理 IP 的来源通常有两种方式，分别对应带外管理和带内管理：
>1.使用专用的物理管理口（带外管理，Out-of-Band）：交换机面板上通常印有 MGMT 或 **`MEth0/0/1`** 的独立网口。**<font color="red">这个网口内部连接到 CPU 的通道与普通数据流量/业务流量是物理隔离的</font>**。IP 直接配置在 **`MEth0/0/1`** 接口上。带外管理口即使交换机业务数据拥塞（比如全网广播风暴、DDoS 攻击），业务网口都 down 掉，依然可以通过这个专用口 SSH 去维护。
>2.使用业务接口的虚拟接口（带内管理，In-Band）：**<font color="red">使用传输用户数据的普通网口（如 **`GigabitEthernet 1/0/1`**）</font>**。IP 配置在 VLANIF 接口或 Loopback 接口 上。创建一个 VLAN（例如 VLAN 100，专门作为管理 VLAN），给这个 VLAN 配置一个三层接口 IP（**`interface Vlanif 100 -> ip address 192.168.100.1`**）。把交换机的某个物理网口划入 VLAN 100。只要电脑能通过网络连通到这个 IP，就可以 SSH 登录。